c6a620cfb9b97d01b2e66da83a85f308
'use strict';

var TransformStream = require('stream').Transform,
    DevNullStream = require('./dev_null_stream'),
    inherits = require('util').inherits,
    Tokenizer = require('../tokenizer'),
    LocationInfoTokenizerMixin = require('../extensions/location_info/tokenizer_mixin'),
    ParserFeedbackSimulator = require('./parser_feedback_simulator'),
    mergeOptions = require('../utils/merge_options');

var DEFAULT_OPTIONS = {
  locationInfo: false
};

var SAXParser = module.exports = function (options) {
  TransformStream.call(this);
  this.options = mergeOptions(DEFAULT_OPTIONS, options);
  this.tokenizer = new Tokenizer(options);
  if (this.options.locationInfo) new LocationInfoTokenizerMixin(this.tokenizer);
  this.parserFeedbackSimulator = new ParserFeedbackSimulator(this.tokenizer);
  this.pendingText = null;
  this.currentTokenLocation = void 0;
  this.lastChunkWritten = false;
  this.stopped = false; // NOTE: always pipe stream to the /dev/null stream to avoid
  // `highWaterMark` hit even if we don't have consumers.
  // (see: https://github.com/inikulin/parse5/issues/97#issuecomment-171940774)

  this.pipe(new DevNullStream());
};

inherits(SAXParser, TransformStream); //TransformStream implementation

SAXParser.prototype._transform = function (chunk, encoding, callback) {
  if (!this.stopped) {
    this.tokenizer.write(chunk.toString('utf8'), this.lastChunkWritten);

    this._runParsingLoop();
  }

  this.push(chunk);
  callback();
};

SAXParser.prototype._flush = function (callback) {
  callback();
};

SAXParser.prototype.end = function (chunk, encoding, callback) {
  this.lastChunkWritten = true;
  TransformStream.prototype.end.call(this, chunk, encoding, callback);
};

SAXParser.prototype.stop = function () {
  this.stopped = true;
}; //Internals


SAXParser.prototype._runParsingLoop = function () {
  do {
    var token = this.parserFeedbackSimulator.getNextToken();
    if (token.type === Tokenizer.HIBERNATION_TOKEN) break;

    if (token.type === Tokenizer.CHARACTER_TOKEN || token.type === Tokenizer.WHITESPACE_CHARACTER_TOKEN || token.type === Tokenizer.NULL_CHARACTER_TOKEN) {
      if (this.options.locationInfo) {
        if (this.pendingText === null) this.currentTokenLocation = token.location;else this.currentTokenLocation.endOffset = token.location.endOffset;
      }

      this.pendingText = (this.pendingText || '') + token.chars;
    } else {
      this._emitPendingText();

      this._handleToken(token);
    }
  } while (!this.stopped && token.type !== Tokenizer.EOF_TOKEN);
};

SAXParser.prototype._handleToken = function (token) {
  if (this.options.locationInfo) this.currentTokenLocation = token.location;
  if (token.type === Tokenizer.START_TAG_TOKEN) this.emit('startTag', token.tagName, token.attrs, token.selfClosing, this.currentTokenLocation);else if (token.type === Tokenizer.END_TAG_TOKEN) this.emit('endTag', token.tagName, this.currentTokenLocation);else if (token.type === Tokenizer.COMMENT_TOKEN) this.emit('comment', token.data, this.currentTokenLocation);else if (token.type === Tokenizer.DOCTYPE_TOKEN) this.emit('doctype', token.name, token.publicId, token.systemId, this.currentTokenLocation);
};

SAXParser.prototype._emitPendingText = function () {
  if (this.pendingText !== null) {
    this.emit('text', this.pendingText, this.currentTokenLocation);
    this.pendingText = null;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIlRyYW5zZm9ybVN0cmVhbSIsInJlcXVpcmUiLCJUcmFuc2Zvcm0iLCJEZXZOdWxsU3RyZWFtIiwiaW5oZXJpdHMiLCJUb2tlbml6ZXIiLCJMb2NhdGlvbkluZm9Ub2tlbml6ZXJNaXhpbiIsIlBhcnNlckZlZWRiYWNrU2ltdWxhdG9yIiwibWVyZ2VPcHRpb25zIiwiREVGQVVMVF9PUFRJT05TIiwibG9jYXRpb25JbmZvIiwiU0FYUGFyc2VyIiwibW9kdWxlIiwiZXhwb3J0cyIsIm9wdGlvbnMiLCJjYWxsIiwidG9rZW5pemVyIiwicGFyc2VyRmVlZGJhY2tTaW11bGF0b3IiLCJwZW5kaW5nVGV4dCIsImN1cnJlbnRUb2tlbkxvY2F0aW9uIiwibGFzdENodW5rV3JpdHRlbiIsInN0b3BwZWQiLCJwaXBlIiwicHJvdG90eXBlIiwiX3RyYW5zZm9ybSIsImNodW5rIiwiZW5jb2RpbmciLCJjYWxsYmFjayIsIndyaXRlIiwidG9TdHJpbmciLCJfcnVuUGFyc2luZ0xvb3AiLCJwdXNoIiwiX2ZsdXNoIiwiZW5kIiwic3RvcCIsInRva2VuIiwiZ2V0TmV4dFRva2VuIiwidHlwZSIsIkhJQkVSTkFUSU9OX1RPS0VOIiwiQ0hBUkFDVEVSX1RPS0VOIiwiV0hJVEVTUEFDRV9DSEFSQUNURVJfVE9LRU4iLCJOVUxMX0NIQVJBQ1RFUl9UT0tFTiIsImxvY2F0aW9uIiwiZW5kT2Zmc2V0IiwiY2hhcnMiLCJfZW1pdFBlbmRpbmdUZXh0IiwiX2hhbmRsZVRva2VuIiwiRU9GX1RPS0VOIiwiU1RBUlRfVEFHX1RPS0VOIiwiZW1pdCIsInRhZ05hbWUiLCJhdHRycyIsInNlbGZDbG9zaW5nIiwiRU5EX1RBR19UT0tFTiIsIkNPTU1FTlRfVE9LRU4iLCJkYXRhIiwiRE9DVFlQRV9UT0tFTiIsIm5hbWUiLCJwdWJsaWNJZCIsInN5c3RlbUlkIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFJQSxlQUFlLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQVAsQ0FBa0JDLFNBQXhDO0FBQUEsSUFDSUMsYUFBYSxHQUFHRixPQUFPLENBQUMsbUJBQUQsQ0FEM0I7QUFBQSxJQUVJRyxRQUFRLEdBQUdILE9BQU8sQ0FBQyxNQUFELENBQVAsQ0FBZ0JHLFFBRi9CO0FBQUEsSUFHSUMsU0FBUyxHQUFHSixPQUFPLENBQUMsY0FBRCxDQUh2QjtBQUFBLElBSUlLLDBCQUEwQixHQUFHTCxPQUFPLENBQUMsNkNBQUQsQ0FKeEM7QUFBQSxJQUtJTSx1QkFBdUIsR0FBR04sT0FBTyxDQUFDLDZCQUFELENBTHJDO0FBQUEsSUFNSU8sWUFBWSxHQUFHUCxPQUFPLENBQUMsd0JBQUQsQ0FOMUI7O0FBUUEsSUFBSVEsZUFBZSxHQUFHO0FBQ2xCQyxFQUFBQSxZQUFZLEVBQUU7QUFESSxDQUF0Qjs7QUFJQSxJQUFJQyxTQUFTLEdBQUdDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixVQUFVQyxPQUFWLEVBQW1CO0FBQ2hEZCxFQUFBQSxlQUFlLENBQUNlLElBQWhCLENBQXFCLElBQXJCO0FBRUEsT0FBS0QsT0FBTCxHQUFlTixZQUFZLENBQUNDLGVBQUQsRUFBa0JLLE9BQWxCLENBQTNCO0FBRUEsT0FBS0UsU0FBTCxHQUFpQixJQUFJWCxTQUFKLENBQWNTLE9BQWQsQ0FBakI7QUFFQSxNQUFJLEtBQUtBLE9BQUwsQ0FBYUosWUFBakIsRUFDSSxJQUFJSiwwQkFBSixDQUErQixLQUFLVSxTQUFwQztBQUVKLE9BQUtDLHVCQUFMLEdBQStCLElBQUlWLHVCQUFKLENBQTRCLEtBQUtTLFNBQWpDLENBQS9CO0FBRUEsT0FBS0UsV0FBTCxHQUFtQixJQUFuQjtBQUNBLE9BQUtDLG9CQUFMLEdBQTRCLEtBQUssQ0FBakM7QUFFQSxPQUFLQyxnQkFBTCxHQUF3QixLQUF4QjtBQUNBLE9BQUtDLE9BQUwsR0FBZSxLQUFmLENBaEJnRCxDQWtCaEQ7QUFDQTtBQUNBOztBQUNBLE9BQUtDLElBQUwsQ0FBVSxJQUFJbkIsYUFBSixFQUFWO0FBQ0gsQ0F0QkQ7O0FBd0JBQyxRQUFRLENBQUNPLFNBQUQsRUFBWVgsZUFBWixDQUFSLEMsQ0FFQTs7QUFDQVcsU0FBUyxDQUFDWSxTQUFWLENBQW9CQyxVQUFwQixHQUFpQyxVQUFVQyxLQUFWLEVBQWlCQyxRQUFqQixFQUEyQkMsUUFBM0IsRUFBcUM7QUFDbEUsTUFBSSxDQUFDLEtBQUtOLE9BQVYsRUFBbUI7QUFDZixTQUFLTCxTQUFMLENBQWVZLEtBQWYsQ0FBcUJILEtBQUssQ0FBQ0ksUUFBTixDQUFlLE1BQWYsQ0FBckIsRUFBNkMsS0FBS1QsZ0JBQWxEOztBQUNBLFNBQUtVLGVBQUw7QUFDSDs7QUFFRCxPQUFLQyxJQUFMLENBQVVOLEtBQVY7QUFFQUUsRUFBQUEsUUFBUTtBQUNYLENBVEQ7O0FBV0FoQixTQUFTLENBQUNZLFNBQVYsQ0FBb0JTLE1BQXBCLEdBQTZCLFVBQVVMLFFBQVYsRUFBb0I7QUFDN0NBLEVBQUFBLFFBQVE7QUFDWCxDQUZEOztBQUlBaEIsU0FBUyxDQUFDWSxTQUFWLENBQW9CVSxHQUFwQixHQUEwQixVQUFVUixLQUFWLEVBQWlCQyxRQUFqQixFQUEyQkMsUUFBM0IsRUFBcUM7QUFDM0QsT0FBS1AsZ0JBQUwsR0FBd0IsSUFBeEI7QUFDQXBCLEVBQUFBLGVBQWUsQ0FBQ3VCLFNBQWhCLENBQTBCVSxHQUExQixDQUE4QmxCLElBQTlCLENBQW1DLElBQW5DLEVBQXlDVSxLQUF6QyxFQUFnREMsUUFBaEQsRUFBMERDLFFBQTFEO0FBQ0gsQ0FIRDs7QUFLQWhCLFNBQVMsQ0FBQ1ksU0FBVixDQUFvQlcsSUFBcEIsR0FBMkIsWUFBWTtBQUNuQyxPQUFLYixPQUFMLEdBQWUsSUFBZjtBQUNILENBRkQsQyxDQUlBOzs7QUFDQVYsU0FBUyxDQUFDWSxTQUFWLENBQW9CTyxlQUFwQixHQUFzQyxZQUFZO0FBQzlDLEtBQUc7QUFDQyxRQUFJSyxLQUFLLEdBQUcsS0FBS2xCLHVCQUFMLENBQTZCbUIsWUFBN0IsRUFBWjtBQUVBLFFBQUlELEtBQUssQ0FBQ0UsSUFBTixLQUFlaEMsU0FBUyxDQUFDaUMsaUJBQTdCLEVBQ0k7O0FBRUosUUFBSUgsS0FBSyxDQUFDRSxJQUFOLEtBQWVoQyxTQUFTLENBQUNrQyxlQUF6QixJQUNBSixLQUFLLENBQUNFLElBQU4sS0FBZWhDLFNBQVMsQ0FBQ21DLDBCQUR6QixJQUVBTCxLQUFLLENBQUNFLElBQU4sS0FBZWhDLFNBQVMsQ0FBQ29DLG9CQUY3QixFQUVtRDtBQUUvQyxVQUFJLEtBQUszQixPQUFMLENBQWFKLFlBQWpCLEVBQStCO0FBQzNCLFlBQUksS0FBS1EsV0FBTCxLQUFxQixJQUF6QixFQUNJLEtBQUtDLG9CQUFMLEdBQTRCZ0IsS0FBSyxDQUFDTyxRQUFsQyxDQURKLEtBSUksS0FBS3ZCLG9CQUFMLENBQTBCd0IsU0FBMUIsR0FBc0NSLEtBQUssQ0FBQ08sUUFBTixDQUFlQyxTQUFyRDtBQUNQOztBQUVELFdBQUt6QixXQUFMLEdBQW1CLENBQUMsS0FBS0EsV0FBTCxJQUFvQixFQUFyQixJQUEyQmlCLEtBQUssQ0FBQ1MsS0FBcEQ7QUFDSCxLQWJELE1BZUs7QUFDRCxXQUFLQyxnQkFBTDs7QUFDQSxXQUFLQyxZQUFMLENBQWtCWCxLQUFsQjtBQUNIO0FBQ0osR0F6QkQsUUF5QlMsQ0FBQyxLQUFLZCxPQUFOLElBQWlCYyxLQUFLLENBQUNFLElBQU4sS0FBZWhDLFNBQVMsQ0FBQzBDLFNBekJuRDtBQTBCSCxDQTNCRDs7QUE2QkFwQyxTQUFTLENBQUNZLFNBQVYsQ0FBb0J1QixZQUFwQixHQUFtQyxVQUFVWCxLQUFWLEVBQWlCO0FBQ2hELE1BQUksS0FBS3JCLE9BQUwsQ0FBYUosWUFBakIsRUFDSSxLQUFLUyxvQkFBTCxHQUE0QmdCLEtBQUssQ0FBQ08sUUFBbEM7QUFFSixNQUFJUCxLQUFLLENBQUNFLElBQU4sS0FBZWhDLFNBQVMsQ0FBQzJDLGVBQTdCLEVBQ0ksS0FBS0MsSUFBTCxDQUFVLFVBQVYsRUFBc0JkLEtBQUssQ0FBQ2UsT0FBNUIsRUFBcUNmLEtBQUssQ0FBQ2dCLEtBQTNDLEVBQWtEaEIsS0FBSyxDQUFDaUIsV0FBeEQsRUFBcUUsS0FBS2pDLG9CQUExRSxFQURKLEtBR0ssSUFBSWdCLEtBQUssQ0FBQ0UsSUFBTixLQUFlaEMsU0FBUyxDQUFDZ0QsYUFBN0IsRUFDRCxLQUFLSixJQUFMLENBQVUsUUFBVixFQUFvQmQsS0FBSyxDQUFDZSxPQUExQixFQUFtQyxLQUFLL0Isb0JBQXhDLEVBREMsS0FHQSxJQUFJZ0IsS0FBSyxDQUFDRSxJQUFOLEtBQWVoQyxTQUFTLENBQUNpRCxhQUE3QixFQUNELEtBQUtMLElBQUwsQ0FBVSxTQUFWLEVBQXFCZCxLQUFLLENBQUNvQixJQUEzQixFQUFpQyxLQUFLcEMsb0JBQXRDLEVBREMsS0FHQSxJQUFJZ0IsS0FBSyxDQUFDRSxJQUFOLEtBQWVoQyxTQUFTLENBQUNtRCxhQUE3QixFQUNELEtBQUtQLElBQUwsQ0FBVSxTQUFWLEVBQXFCZCxLQUFLLENBQUNzQixJQUEzQixFQUFpQ3RCLEtBQUssQ0FBQ3VCLFFBQXZDLEVBQWlEdkIsS0FBSyxDQUFDd0IsUUFBdkQsRUFBaUUsS0FBS3hDLG9CQUF0RTtBQUNQLENBZkQ7O0FBaUJBUixTQUFTLENBQUNZLFNBQVYsQ0FBb0JzQixnQkFBcEIsR0FBdUMsWUFBWTtBQUMvQyxNQUFJLEtBQUszQixXQUFMLEtBQXFCLElBQXpCLEVBQStCO0FBQzNCLFNBQUsrQixJQUFMLENBQVUsTUFBVixFQUFrQixLQUFLL0IsV0FBdkIsRUFBb0MsS0FBS0Msb0JBQXpDO0FBQ0EsU0FBS0QsV0FBTCxHQUFtQixJQUFuQjtBQUNIO0FBQ0osQ0FMRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIFRyYW5zZm9ybVN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpLlRyYW5zZm9ybSxcbiAgICBEZXZOdWxsU3RyZWFtID0gcmVxdWlyZSgnLi9kZXZfbnVsbF9zdHJlYW0nKSxcbiAgICBpbmhlcml0cyA9IHJlcXVpcmUoJ3V0aWwnKS5pbmhlcml0cyxcbiAgICBUb2tlbml6ZXIgPSByZXF1aXJlKCcuLi90b2tlbml6ZXInKSxcbiAgICBMb2NhdGlvbkluZm9Ub2tlbml6ZXJNaXhpbiA9IHJlcXVpcmUoJy4uL2V4dGVuc2lvbnMvbG9jYXRpb25faW5mby90b2tlbml6ZXJfbWl4aW4nKSxcbiAgICBQYXJzZXJGZWVkYmFja1NpbXVsYXRvciA9IHJlcXVpcmUoJy4vcGFyc2VyX2ZlZWRiYWNrX3NpbXVsYXRvcicpLFxuICAgIG1lcmdlT3B0aW9ucyA9IHJlcXVpcmUoJy4uL3V0aWxzL21lcmdlX29wdGlvbnMnKTtcblxudmFyIERFRkFVTFRfT1BUSU9OUyA9IHtcbiAgICBsb2NhdGlvbkluZm86IGZhbHNlXG59O1xuXG52YXIgU0FYUGFyc2VyID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgIFRyYW5zZm9ybVN0cmVhbS5jYWxsKHRoaXMpO1xuXG4gICAgdGhpcy5vcHRpb25zID0gbWVyZ2VPcHRpb25zKERFRkFVTFRfT1BUSU9OUywgb3B0aW9ucyk7XG5cbiAgICB0aGlzLnRva2VuaXplciA9IG5ldyBUb2tlbml6ZXIob3B0aW9ucyk7XG5cbiAgICBpZiAodGhpcy5vcHRpb25zLmxvY2F0aW9uSW5mbylcbiAgICAgICAgbmV3IExvY2F0aW9uSW5mb1Rva2VuaXplck1peGluKHRoaXMudG9rZW5pemVyKTtcblxuICAgIHRoaXMucGFyc2VyRmVlZGJhY2tTaW11bGF0b3IgPSBuZXcgUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IodGhpcy50b2tlbml6ZXIpO1xuXG4gICAgdGhpcy5wZW5kaW5nVGV4dCA9IG51bGw7XG4gICAgdGhpcy5jdXJyZW50VG9rZW5Mb2NhdGlvbiA9IHZvaWQgMDtcblxuICAgIHRoaXMubGFzdENodW5rV3JpdHRlbiA9IGZhbHNlO1xuICAgIHRoaXMuc3RvcHBlZCA9IGZhbHNlO1xuXG4gICAgLy8gTk9URTogYWx3YXlzIHBpcGUgc3RyZWFtIHRvIHRoZSAvZGV2L251bGwgc3RyZWFtIHRvIGF2b2lkXG4gICAgLy8gYGhpZ2hXYXRlck1hcmtgIGhpdCBldmVuIGlmIHdlIGRvbid0IGhhdmUgY29uc3VtZXJzLlxuICAgIC8vIChzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9pbmlrdWxpbi9wYXJzZTUvaXNzdWVzLzk3I2lzc3VlY29tbWVudC0xNzE5NDA3NzQpXG4gICAgdGhpcy5waXBlKG5ldyBEZXZOdWxsU3RyZWFtKCkpO1xufTtcblxuaW5oZXJpdHMoU0FYUGFyc2VyLCBUcmFuc2Zvcm1TdHJlYW0pO1xuXG4vL1RyYW5zZm9ybVN0cmVhbSBpbXBsZW1lbnRhdGlvblxuU0FYUGFyc2VyLnByb3RvdHlwZS5fdHJhbnNmb3JtID0gZnVuY3Rpb24gKGNodW5rLCBlbmNvZGluZywgY2FsbGJhY2spIHtcbiAgICBpZiAoIXRoaXMuc3RvcHBlZCkge1xuICAgICAgICB0aGlzLnRva2VuaXplci53cml0ZShjaHVuay50b1N0cmluZygndXRmOCcpLCB0aGlzLmxhc3RDaHVua1dyaXR0ZW4pO1xuICAgICAgICB0aGlzLl9ydW5QYXJzaW5nTG9vcCgpO1xuICAgIH1cblxuICAgIHRoaXMucHVzaChjaHVuayk7XG5cbiAgICBjYWxsYmFjaygpO1xufTtcblxuU0FYUGFyc2VyLnByb3RvdHlwZS5fZmx1c2ggPSBmdW5jdGlvbiAoY2FsbGJhY2spIHtcbiAgICBjYWxsYmFjaygpO1xufTtcblxuU0FYUGFyc2VyLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbiAoY2h1bmssIGVuY29kaW5nLCBjYWxsYmFjaykge1xuICAgIHRoaXMubGFzdENodW5rV3JpdHRlbiA9IHRydWU7XG4gICAgVHJhbnNmb3JtU3RyZWFtLnByb3RvdHlwZS5lbmQuY2FsbCh0aGlzLCBjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKTtcbn07XG5cblNBWFBhcnNlci5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnN0b3BwZWQgPSB0cnVlO1xufTtcblxuLy9JbnRlcm5hbHNcblNBWFBhcnNlci5wcm90b3R5cGUuX3J1blBhcnNpbmdMb29wID0gZnVuY3Rpb24gKCkge1xuICAgIGRvIHtcbiAgICAgICAgdmFyIHRva2VuID0gdGhpcy5wYXJzZXJGZWVkYmFja1NpbXVsYXRvci5nZXROZXh0VG9rZW4oKTtcblxuICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLkhJQkVSTkFUSU9OX1RPS0VOKVxuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuaXplci5DSEFSQUNURVJfVE9LRU4gfHxcbiAgICAgICAgICAgIHRva2VuLnR5cGUgPT09IFRva2VuaXplci5XSElURVNQQUNFX0NIQVJBQ1RFUl9UT0tFTiB8fFxuICAgICAgICAgICAgdG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLk5VTExfQ0hBUkFDVEVSX1RPS0VOKSB7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9jYXRpb25JbmZvKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGVuZGluZ1RleHQgPT09IG51bGwpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFRva2VuTG9jYXRpb24gPSB0b2tlbi5sb2NhdGlvbjtcblxuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VG9rZW5Mb2NhdGlvbi5lbmRPZmZzZXQgPSB0b2tlbi5sb2NhdGlvbi5lbmRPZmZzZXQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMucGVuZGluZ1RleHQgPSAodGhpcy5wZW5kaW5nVGV4dCB8fCAnJykgKyB0b2tlbi5jaGFycztcbiAgICAgICAgfVxuXG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fZW1pdFBlbmRpbmdUZXh0KCk7XG4gICAgICAgICAgICB0aGlzLl9oYW5kbGVUb2tlbih0b2tlbik7XG4gICAgICAgIH1cbiAgICB9IHdoaWxlICghdGhpcy5zdG9wcGVkICYmIHRva2VuLnR5cGUgIT09IFRva2VuaXplci5FT0ZfVE9LRU4pO1xufTtcblxuU0FYUGFyc2VyLnByb3RvdHlwZS5faGFuZGxlVG9rZW4gPSBmdW5jdGlvbiAodG9rZW4pIHtcbiAgICBpZiAodGhpcy5vcHRpb25zLmxvY2F0aW9uSW5mbylcbiAgICAgICAgdGhpcy5jdXJyZW50VG9rZW5Mb2NhdGlvbiA9IHRva2VuLmxvY2F0aW9uO1xuXG4gICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuaXplci5TVEFSVF9UQUdfVE9LRU4pXG4gICAgICAgIHRoaXMuZW1pdCgnc3RhcnRUYWcnLCB0b2tlbi50YWdOYW1lLCB0b2tlbi5hdHRycywgdG9rZW4uc2VsZkNsb3NpbmcsIHRoaXMuY3VycmVudFRva2VuTG9jYXRpb24pO1xuXG4gICAgZWxzZSBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLkVORF9UQUdfVE9LRU4pXG4gICAgICAgIHRoaXMuZW1pdCgnZW5kVGFnJywgdG9rZW4udGFnTmFtZSwgdGhpcy5jdXJyZW50VG9rZW5Mb2NhdGlvbik7XG5cbiAgICBlbHNlIGlmICh0b2tlbi50eXBlID09PSBUb2tlbml6ZXIuQ09NTUVOVF9UT0tFTilcbiAgICAgICAgdGhpcy5lbWl0KCdjb21tZW50JywgdG9rZW4uZGF0YSwgdGhpcy5jdXJyZW50VG9rZW5Mb2NhdGlvbik7XG5cbiAgICBlbHNlIGlmICh0b2tlbi50eXBlID09PSBUb2tlbml6ZXIuRE9DVFlQRV9UT0tFTilcbiAgICAgICAgdGhpcy5lbWl0KCdkb2N0eXBlJywgdG9rZW4ubmFtZSwgdG9rZW4ucHVibGljSWQsIHRva2VuLnN5c3RlbUlkLCB0aGlzLmN1cnJlbnRUb2tlbkxvY2F0aW9uKTtcbn07XG5cblNBWFBhcnNlci5wcm90b3R5cGUuX2VtaXRQZW5kaW5nVGV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAodGhpcy5wZW5kaW5nVGV4dCAhPT0gbnVsbCkge1xuICAgICAgICB0aGlzLmVtaXQoJ3RleHQnLCB0aGlzLnBlbmRpbmdUZXh0LCB0aGlzLmN1cnJlbnRUb2tlbkxvY2F0aW9uKTtcbiAgICAgICAgdGhpcy5wZW5kaW5nVGV4dCA9IG51bGw7XG4gICAgfVxufTtcbiJdfQ==