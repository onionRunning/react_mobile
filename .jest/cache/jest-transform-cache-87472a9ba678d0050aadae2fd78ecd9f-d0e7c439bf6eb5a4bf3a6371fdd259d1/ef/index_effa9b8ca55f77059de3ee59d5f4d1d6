2fe6a30f4cbbc72486f705594533ecaf
var ElementType = require("domelementtype");

var re_whitespace = /\s+/g;

var NodePrototype = require("./lib/node");

var ElementPrototype = require("./lib/element");

function DomHandler(callback, options, elementCB) {
  if (typeof callback === "object") {
    elementCB = options;
    options = callback;
    callback = null;
  } else if (typeof options === "function") {
    elementCB = options;
    options = defaultOpts;
  }

  this._callback = callback;
  this._options = options || defaultOpts;
  this._elementCB = elementCB;
  this.dom = [];
  this._done = false;
  this._tagStack = [];
  this._parser = this._parser || null;
} //default options


var defaultOpts = {
  normalizeWhitespace: false,
  //Replace all whitespace with single spaces
  withStartIndices: false,
  //Add startIndex properties to nodes
  withEndIndices: false //Add endIndex properties to nodes

};

DomHandler.prototype.onparserinit = function (parser) {
  this._parser = parser;
}; //Resets the handler back to starting state


DomHandler.prototype.onreset = function () {
  DomHandler.call(this, this._callback, this._options, this._elementCB);
}; //Signals the handler that parsing is done


DomHandler.prototype.onend = function () {
  if (this._done) return;
  this._done = true;
  this._parser = null;

  this._handleCallback(null);
};

DomHandler.prototype._handleCallback = DomHandler.prototype.onerror = function (error) {
  if (typeof this._callback === "function") {
    this._callback(error, this.dom);
  } else {
    if (error) throw error;
  }
};

DomHandler.prototype.onclosetag = function () {
  //if(this._tagStack.pop().name !== name) this._handleCallback(Error("Tagname didn't match!"));
  var elem = this._tagStack.pop();

  if (this._options.withEndIndices && elem) {
    elem.endIndex = this._parser.endIndex;
  }

  if (this._elementCB) this._elementCB(elem);
};

DomHandler.prototype._createDomElement = function (properties) {
  if (!this._options.withDomLvl1) return properties;
  var element;

  if (properties.type === "tag") {
    element = Object.create(ElementPrototype);
  } else {
    element = Object.create(NodePrototype);
  }

  for (var key in properties) {
    if (properties.hasOwnProperty(key)) {
      element[key] = properties[key];
    }
  }

  return element;
};

DomHandler.prototype._addDomElement = function (element) {
  var parent = this._tagStack[this._tagStack.length - 1];
  var siblings = parent ? parent.children : this.dom;
  var previousSibling = siblings[siblings.length - 1];
  element.next = null;

  if (this._options.withStartIndices) {
    element.startIndex = this._parser.startIndex;
  }

  if (this._options.withEndIndices) {
    element.endIndex = this._parser.endIndex;
  }

  if (previousSibling) {
    element.prev = previousSibling;
    previousSibling.next = element;
  } else {
    element.prev = null;
  }

  siblings.push(element);
  element.parent = parent || null;
};

DomHandler.prototype.onopentag = function (name, attribs) {
  var properties = {
    type: name === "script" ? ElementType.Script : name === "style" ? ElementType.Style : ElementType.Tag,
    name: name,
    attribs: attribs,
    children: []
  };

  var element = this._createDomElement(properties);

  this._addDomElement(element);

  this._tagStack.push(element);
};

DomHandler.prototype.ontext = function (data) {
  //the ignoreWhitespace is officially dropped, but for now,
  //it's an alias for normalizeWhitespace
  var normalize = this._options.normalizeWhitespace || this._options.ignoreWhitespace;
  var lastTag;

  if (!this._tagStack.length && this.dom.length && (lastTag = this.dom[this.dom.length - 1]).type === ElementType.Text) {
    if (normalize) {
      lastTag.data = (lastTag.data + data).replace(re_whitespace, " ");
    } else {
      lastTag.data += data;
    }
  } else {
    if (this._tagStack.length && (lastTag = this._tagStack[this._tagStack.length - 1]) && (lastTag = lastTag.children[lastTag.children.length - 1]) && lastTag.type === ElementType.Text) {
      if (normalize) {
        lastTag.data = (lastTag.data + data).replace(re_whitespace, " ");
      } else {
        lastTag.data += data;
      }
    } else {
      if (normalize) {
        data = data.replace(re_whitespace, " ");
      }

      var element = this._createDomElement({
        data: data,
        type: ElementType.Text
      });

      this._addDomElement(element);
    }
  }
};

DomHandler.prototype.oncomment = function (data) {
  var lastTag = this._tagStack[this._tagStack.length - 1];

  if (lastTag && lastTag.type === ElementType.Comment) {
    lastTag.data += data;
    return;
  }

  var properties = {
    data: data,
    type: ElementType.Comment
  };

  var element = this._createDomElement(properties);

  this._addDomElement(element);

  this._tagStack.push(element);
};

DomHandler.prototype.oncdatastart = function () {
  var properties = {
    children: [{
      data: "",
      type: ElementType.Text
    }],
    type: ElementType.CDATA
  };

  var element = this._createDomElement(properties);

  this._addDomElement(element);

  this._tagStack.push(element);
};

DomHandler.prototype.oncommentend = DomHandler.prototype.oncdataend = function () {
  this._tagStack.pop();
};

DomHandler.prototype.onprocessinginstruction = function (name, data) {
  var element = this._createDomElement({
    name: name,
    data: data,
    type: ElementType.Directive
  });

  this._addDomElement(element);
};

module.exports = DomHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIkVsZW1lbnRUeXBlIiwicmVxdWlyZSIsInJlX3doaXRlc3BhY2UiLCJOb2RlUHJvdG90eXBlIiwiRWxlbWVudFByb3RvdHlwZSIsIkRvbUhhbmRsZXIiLCJjYWxsYmFjayIsIm9wdGlvbnMiLCJlbGVtZW50Q0IiLCJkZWZhdWx0T3B0cyIsIl9jYWxsYmFjayIsIl9vcHRpb25zIiwiX2VsZW1lbnRDQiIsImRvbSIsIl9kb25lIiwiX3RhZ1N0YWNrIiwiX3BhcnNlciIsIm5vcm1hbGl6ZVdoaXRlc3BhY2UiLCJ3aXRoU3RhcnRJbmRpY2VzIiwid2l0aEVuZEluZGljZXMiLCJwcm90b3R5cGUiLCJvbnBhcnNlcmluaXQiLCJwYXJzZXIiLCJvbnJlc2V0IiwiY2FsbCIsIm9uZW5kIiwiX2hhbmRsZUNhbGxiYWNrIiwib25lcnJvciIsImVycm9yIiwib25jbG9zZXRhZyIsImVsZW0iLCJwb3AiLCJlbmRJbmRleCIsIl9jcmVhdGVEb21FbGVtZW50IiwicHJvcGVydGllcyIsIndpdGhEb21MdmwxIiwiZWxlbWVudCIsInR5cGUiLCJPYmplY3QiLCJjcmVhdGUiLCJrZXkiLCJoYXNPd25Qcm9wZXJ0eSIsIl9hZGREb21FbGVtZW50IiwicGFyZW50IiwibGVuZ3RoIiwic2libGluZ3MiLCJjaGlsZHJlbiIsInByZXZpb3VzU2libGluZyIsIm5leHQiLCJzdGFydEluZGV4IiwicHJldiIsInB1c2giLCJvbm9wZW50YWciLCJuYW1lIiwiYXR0cmlicyIsIlNjcmlwdCIsIlN0eWxlIiwiVGFnIiwib250ZXh0IiwiZGF0YSIsIm5vcm1hbGl6ZSIsImlnbm9yZVdoaXRlc3BhY2UiLCJsYXN0VGFnIiwiVGV4dCIsInJlcGxhY2UiLCJvbmNvbW1lbnQiLCJDb21tZW50Iiwib25jZGF0YXN0YXJ0IiwiQ0RBVEEiLCJvbmNvbW1lbnRlbmQiLCJvbmNkYXRhZW5kIiwib25wcm9jZXNzaW5naW5zdHJ1Y3Rpb24iLCJEaXJlY3RpdmUiLCJtb2R1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Q0FqQkQ7O0FBbUJBL0IsVUFBVSxDQUFDZSxTQUFYLENBQXFCK0MsWUFBckIsR0FBb0MsWUFBVTtBQUM3QyxNQUFJakMsVUFBVSxHQUFHO0FBQ2hCWSxJQUFBQSxRQUFRLEVBQUUsQ0FBQztBQUNWYSxNQUFBQSxJQUFJLEVBQUUsRUFESTtBQUVWdEIsTUFBQUEsSUFBSSxFQUFFckMsV0FBVyxDQUFDK0Q7QUFGUixLQUFELENBRE07QUFLaEIxQixJQUFBQSxJQUFJLEVBQUVyQyxXQUFXLENBQUNvRTtBQUxGLEdBQWpCOztBQVFBLE1BQUloQyxPQUFPLEdBQUcsS0FBS0gsaUJBQUwsQ0FBdUJDLFVBQXZCLENBQWQ7O0FBRUEsT0FBS1EsY0FBTCxDQUFvQk4sT0FBcEI7O0FBQ0EsT0FBS3JCLFNBQUwsQ0FBZW9DLElBQWYsQ0FBb0JmLE9BQXBCO0FBQ0EsQ0FiRDs7QUFlQS9CLFVBQVUsQ0FBQ2UsU0FBWCxDQUFxQmlELFlBQXJCLEdBQW9DaEUsVUFBVSxDQUFDZSxTQUFYLENBQXFCa0QsVUFBckIsR0FBa0MsWUFBVTtBQUMvRSxPQUFLdkQsU0FBTCxDQUFlZ0IsR0FBZjtBQUNBLENBRkQ7O0FBSUExQixVQUFVLENBQUNlLFNBQVgsQ0FBcUJtRCx1QkFBckIsR0FBK0MsVUFBU2xCLElBQVQsRUFBZU0sSUFBZixFQUFvQjtBQUNsRSxNQUFJdkIsT0FBTyxHQUFHLEtBQUtILGlCQUFMLENBQXVCO0FBQ3BDb0IsSUFBQUEsSUFBSSxFQUFFQSxJQUQ4QjtBQUVwQ00sSUFBQUEsSUFBSSxFQUFFQSxJQUY4QjtBQUdwQ3RCLElBQUFBLElBQUksRUFBRXJDLFdBQVcsQ0FBQ3dFO0FBSGtCLEdBQXZCLENBQWQ7O0FBTUEsT0FBSzlCLGNBQUwsQ0FBb0JOLE9BQXBCO0FBQ0EsQ0FSRDs7QUFVQXFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnJFLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEVsZW1lbnRUeXBlID0gcmVxdWlyZShcImRvbWVsZW1lbnR0eXBlXCIpO1xuXG52YXIgcmVfd2hpdGVzcGFjZSA9IC9cXHMrL2c7XG52YXIgTm9kZVByb3RvdHlwZSA9IHJlcXVpcmUoXCIuL2xpYi9ub2RlXCIpO1xudmFyIEVsZW1lbnRQcm90b3R5cGUgPSByZXF1aXJlKFwiLi9saWIvZWxlbWVudFwiKTtcblxuZnVuY3Rpb24gRG9tSGFuZGxlcihjYWxsYmFjaywgb3B0aW9ucywgZWxlbWVudENCKXtcblx0aWYodHlwZW9mIGNhbGxiYWNrID09PSBcIm9iamVjdFwiKXtcblx0XHRlbGVtZW50Q0IgPSBvcHRpb25zO1xuXHRcdG9wdGlvbnMgPSBjYWxsYmFjaztcblx0XHRjYWxsYmFjayA9IG51bGw7XG5cdH0gZWxzZSBpZih0eXBlb2Ygb3B0aW9ucyA9PT0gXCJmdW5jdGlvblwiKXtcblx0XHRlbGVtZW50Q0IgPSBvcHRpb25zO1xuXHRcdG9wdGlvbnMgPSBkZWZhdWx0T3B0cztcblx0fVxuXHR0aGlzLl9jYWxsYmFjayA9IGNhbGxiYWNrO1xuXHR0aGlzLl9vcHRpb25zID0gb3B0aW9ucyB8fCBkZWZhdWx0T3B0cztcblx0dGhpcy5fZWxlbWVudENCID0gZWxlbWVudENCO1xuXHR0aGlzLmRvbSA9IFtdO1xuXHR0aGlzLl9kb25lID0gZmFsc2U7XG5cdHRoaXMuX3RhZ1N0YWNrID0gW107XG5cdHRoaXMuX3BhcnNlciA9IHRoaXMuX3BhcnNlciB8fCBudWxsO1xufVxuXG4vL2RlZmF1bHQgb3B0aW9uc1xudmFyIGRlZmF1bHRPcHRzID0ge1xuXHRub3JtYWxpemVXaGl0ZXNwYWNlOiBmYWxzZSwgLy9SZXBsYWNlIGFsbCB3aGl0ZXNwYWNlIHdpdGggc2luZ2xlIHNwYWNlc1xuXHR3aXRoU3RhcnRJbmRpY2VzOiBmYWxzZSwgLy9BZGQgc3RhcnRJbmRleCBwcm9wZXJ0aWVzIHRvIG5vZGVzXG5cdHdpdGhFbmRJbmRpY2VzOiBmYWxzZSwgLy9BZGQgZW5kSW5kZXggcHJvcGVydGllcyB0byBub2Rlc1xufTtcblxuRG9tSGFuZGxlci5wcm90b3R5cGUub25wYXJzZXJpbml0ID0gZnVuY3Rpb24ocGFyc2VyKXtcblx0dGhpcy5fcGFyc2VyID0gcGFyc2VyO1xufTtcblxuLy9SZXNldHMgdGhlIGhhbmRsZXIgYmFjayB0byBzdGFydGluZyBzdGF0ZVxuRG9tSGFuZGxlci5wcm90b3R5cGUub25yZXNldCA9IGZ1bmN0aW9uKCl7XG5cdERvbUhhbmRsZXIuY2FsbCh0aGlzLCB0aGlzLl9jYWxsYmFjaywgdGhpcy5fb3B0aW9ucywgdGhpcy5fZWxlbWVudENCKTtcbn07XG5cbi8vU2lnbmFscyB0aGUgaGFuZGxlciB0aGF0IHBhcnNpbmcgaXMgZG9uZVxuRG9tSGFuZGxlci5wcm90b3R5cGUub25lbmQgPSBmdW5jdGlvbigpe1xuXHRpZih0aGlzLl9kb25lKSByZXR1cm47XG5cdHRoaXMuX2RvbmUgPSB0cnVlO1xuXHR0aGlzLl9wYXJzZXIgPSBudWxsO1xuXHR0aGlzLl9oYW5kbGVDYWxsYmFjayhudWxsKTtcbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLl9oYW5kbGVDYWxsYmFjayA9XG5Eb21IYW5kbGVyLnByb3RvdHlwZS5vbmVycm9yID0gZnVuY3Rpb24oZXJyb3Ipe1xuXHRpZih0eXBlb2YgdGhpcy5fY2FsbGJhY2sgPT09IFwiZnVuY3Rpb25cIil7XG5cdFx0dGhpcy5fY2FsbGJhY2soZXJyb3IsIHRoaXMuZG9tKTtcblx0fSBlbHNlIHtcblx0XHRpZihlcnJvcikgdGhyb3cgZXJyb3I7XG5cdH1cbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLm9uY2xvc2V0YWcgPSBmdW5jdGlvbigpe1xuXHQvL2lmKHRoaXMuX3RhZ1N0YWNrLnBvcCgpLm5hbWUgIT09IG5hbWUpIHRoaXMuX2hhbmRsZUNhbGxiYWNrKEVycm9yKFwiVGFnbmFtZSBkaWRuJ3QgbWF0Y2ghXCIpKTtcblx0XG5cdHZhciBlbGVtID0gdGhpcy5fdGFnU3RhY2sucG9wKCk7XG5cblx0aWYodGhpcy5fb3B0aW9ucy53aXRoRW5kSW5kaWNlcyAmJiBlbGVtKXtcblx0XHRlbGVtLmVuZEluZGV4ID0gdGhpcy5fcGFyc2VyLmVuZEluZGV4O1xuXHR9XG5cblx0aWYodGhpcy5fZWxlbWVudENCKSB0aGlzLl9lbGVtZW50Q0IoZWxlbSk7XG59O1xuXG5Eb21IYW5kbGVyLnByb3RvdHlwZS5fY3JlYXRlRG9tRWxlbWVudCA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpe1xuXHRpZiAoIXRoaXMuX29wdGlvbnMud2l0aERvbUx2bDEpIHJldHVybiBwcm9wZXJ0aWVzO1xuXG5cdHZhciBlbGVtZW50O1xuXHRpZiAocHJvcGVydGllcy50eXBlID09PSBcInRhZ1wiKSB7XG5cdFx0ZWxlbWVudCA9IE9iamVjdC5jcmVhdGUoRWxlbWVudFByb3RvdHlwZSk7XG5cdH0gZWxzZSB7XG5cdFx0ZWxlbWVudCA9IE9iamVjdC5jcmVhdGUoTm9kZVByb3RvdHlwZSk7XG5cdH1cblxuXHRmb3IgKHZhciBrZXkgaW4gcHJvcGVydGllcykge1xuXHRcdGlmIChwcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KGtleSkpIHtcblx0XHRcdGVsZW1lbnRba2V5XSA9IHByb3BlcnRpZXNba2V5XTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gZWxlbWVudDtcbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLl9hZGREb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCl7XG5cdHZhciBwYXJlbnQgPSB0aGlzLl90YWdTdGFja1t0aGlzLl90YWdTdGFjay5sZW5ndGggLSAxXTtcblx0dmFyIHNpYmxpbmdzID0gcGFyZW50ID8gcGFyZW50LmNoaWxkcmVuIDogdGhpcy5kb207XG5cdHZhciBwcmV2aW91c1NpYmxpbmcgPSBzaWJsaW5nc1tzaWJsaW5ncy5sZW5ndGggLSAxXTtcblxuXHRlbGVtZW50Lm5leHQgPSBudWxsO1xuXG5cdGlmKHRoaXMuX29wdGlvbnMud2l0aFN0YXJ0SW5kaWNlcyl7XG5cdFx0ZWxlbWVudC5zdGFydEluZGV4ID0gdGhpcy5fcGFyc2VyLnN0YXJ0SW5kZXg7XG5cdH1cblx0aWYodGhpcy5fb3B0aW9ucy53aXRoRW5kSW5kaWNlcyl7XG5cdFx0ZWxlbWVudC5lbmRJbmRleCA9IHRoaXMuX3BhcnNlci5lbmRJbmRleDtcblx0fVxuXG5cdGlmKHByZXZpb3VzU2libGluZyl7XG5cdFx0ZWxlbWVudC5wcmV2ID0gcHJldmlvdXNTaWJsaW5nO1xuXHRcdHByZXZpb3VzU2libGluZy5uZXh0ID0gZWxlbWVudDtcblx0fSBlbHNlIHtcblx0XHRlbGVtZW50LnByZXYgPSBudWxsO1xuXHR9XG5cblx0c2libGluZ3MucHVzaChlbGVtZW50KTtcblx0ZWxlbWVudC5wYXJlbnQgPSBwYXJlbnQgfHwgbnVsbDtcbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLm9ub3BlbnRhZyA9IGZ1bmN0aW9uKG5hbWUsIGF0dHJpYnMpe1xuXHR2YXIgcHJvcGVydGllcyA9IHtcblx0XHR0eXBlOiBuYW1lID09PSBcInNjcmlwdFwiID8gRWxlbWVudFR5cGUuU2NyaXB0IDogbmFtZSA9PT0gXCJzdHlsZVwiID8gRWxlbWVudFR5cGUuU3R5bGUgOiBFbGVtZW50VHlwZS5UYWcsXG5cdFx0bmFtZTogbmFtZSxcblx0XHRhdHRyaWJzOiBhdHRyaWJzLFxuXHRcdGNoaWxkcmVuOiBbXVxuXHR9O1xuXG5cdHZhciBlbGVtZW50ID0gdGhpcy5fY3JlYXRlRG9tRWxlbWVudChwcm9wZXJ0aWVzKTtcblxuXHR0aGlzLl9hZGREb21FbGVtZW50KGVsZW1lbnQpO1xuXG5cdHRoaXMuX3RhZ1N0YWNrLnB1c2goZWxlbWVudCk7XG59O1xuXG5Eb21IYW5kbGVyLnByb3RvdHlwZS5vbnRleHQgPSBmdW5jdGlvbihkYXRhKXtcblx0Ly90aGUgaWdub3JlV2hpdGVzcGFjZSBpcyBvZmZpY2lhbGx5IGRyb3BwZWQsIGJ1dCBmb3Igbm93LFxuXHQvL2l0J3MgYW4gYWxpYXMgZm9yIG5vcm1hbGl6ZVdoaXRlc3BhY2Vcblx0dmFyIG5vcm1hbGl6ZSA9IHRoaXMuX29wdGlvbnMubm9ybWFsaXplV2hpdGVzcGFjZSB8fCB0aGlzLl9vcHRpb25zLmlnbm9yZVdoaXRlc3BhY2U7XG5cblx0dmFyIGxhc3RUYWc7XG5cblx0aWYoIXRoaXMuX3RhZ1N0YWNrLmxlbmd0aCAmJiB0aGlzLmRvbS5sZW5ndGggJiYgKGxhc3RUYWcgPSB0aGlzLmRvbVt0aGlzLmRvbS5sZW5ndGgtMV0pLnR5cGUgPT09IEVsZW1lbnRUeXBlLlRleHQpe1xuXHRcdGlmKG5vcm1hbGl6ZSl7XG5cdFx0XHRsYXN0VGFnLmRhdGEgPSAobGFzdFRhZy5kYXRhICsgZGF0YSkucmVwbGFjZShyZV93aGl0ZXNwYWNlLCBcIiBcIik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxhc3RUYWcuZGF0YSArPSBkYXRhO1xuXHRcdH1cblx0fSBlbHNlIHtcblx0XHRpZihcblx0XHRcdHRoaXMuX3RhZ1N0YWNrLmxlbmd0aCAmJlxuXHRcdFx0KGxhc3RUYWcgPSB0aGlzLl90YWdTdGFja1t0aGlzLl90YWdTdGFjay5sZW5ndGggLSAxXSkgJiZcblx0XHRcdChsYXN0VGFnID0gbGFzdFRhZy5jaGlsZHJlbltsYXN0VGFnLmNoaWxkcmVuLmxlbmd0aCAtIDFdKSAmJlxuXHRcdFx0bGFzdFRhZy50eXBlID09PSBFbGVtZW50VHlwZS5UZXh0XG5cdFx0KXtcblx0XHRcdGlmKG5vcm1hbGl6ZSl7XG5cdFx0XHRcdGxhc3RUYWcuZGF0YSA9IChsYXN0VGFnLmRhdGEgKyBkYXRhKS5yZXBsYWNlKHJlX3doaXRlc3BhY2UsIFwiIFwiKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGxhc3RUYWcuZGF0YSArPSBkYXRhO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRpZihub3JtYWxpemUpe1xuXHRcdFx0XHRkYXRhID0gZGF0YS5yZXBsYWNlKHJlX3doaXRlc3BhY2UsIFwiIFwiKTtcblx0XHRcdH1cblxuXHRcdFx0dmFyIGVsZW1lbnQgPSB0aGlzLl9jcmVhdGVEb21FbGVtZW50KHtcblx0XHRcdFx0ZGF0YTogZGF0YSxcblx0XHRcdFx0dHlwZTogRWxlbWVudFR5cGUuVGV4dFxuXHRcdFx0fSk7XG5cblx0XHRcdHRoaXMuX2FkZERvbUVsZW1lbnQoZWxlbWVudCk7XG5cdFx0fVxuXHR9XG59O1xuXG5Eb21IYW5kbGVyLnByb3RvdHlwZS5vbmNvbW1lbnQgPSBmdW5jdGlvbihkYXRhKXtcblx0dmFyIGxhc3RUYWcgPSB0aGlzLl90YWdTdGFja1t0aGlzLl90YWdTdGFjay5sZW5ndGggLSAxXTtcblxuXHRpZihsYXN0VGFnICYmIGxhc3RUYWcudHlwZSA9PT0gRWxlbWVudFR5cGUuQ29tbWVudCl7XG5cdFx0bGFzdFRhZy5kYXRhICs9IGRhdGE7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0dmFyIHByb3BlcnRpZXMgPSB7XG5cdFx0ZGF0YTogZGF0YSxcblx0XHR0eXBlOiBFbGVtZW50VHlwZS5Db21tZW50XG5cdH07XG5cblx0dmFyIGVsZW1lbnQgPSB0aGlzLl9jcmVhdGVEb21FbGVtZW50KHByb3BlcnRpZXMpO1xuXG5cdHRoaXMuX2FkZERvbUVsZW1lbnQoZWxlbWVudCk7XG5cdHRoaXMuX3RhZ1N0YWNrLnB1c2goZWxlbWVudCk7XG59O1xuXG5Eb21IYW5kbGVyLnByb3RvdHlwZS5vbmNkYXRhc3RhcnQgPSBmdW5jdGlvbigpe1xuXHR2YXIgcHJvcGVydGllcyA9IHtcblx0XHRjaGlsZHJlbjogW3tcblx0XHRcdGRhdGE6IFwiXCIsXG5cdFx0XHR0eXBlOiBFbGVtZW50VHlwZS5UZXh0XG5cdFx0fV0sXG5cdFx0dHlwZTogRWxlbWVudFR5cGUuQ0RBVEFcblx0fTtcblxuXHR2YXIgZWxlbWVudCA9IHRoaXMuX2NyZWF0ZURvbUVsZW1lbnQocHJvcGVydGllcyk7XG5cblx0dGhpcy5fYWRkRG9tRWxlbWVudChlbGVtZW50KTtcblx0dGhpcy5fdGFnU3RhY2sucHVzaChlbGVtZW50KTtcbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLm9uY29tbWVudGVuZCA9IERvbUhhbmRsZXIucHJvdG90eXBlLm9uY2RhdGFlbmQgPSBmdW5jdGlvbigpe1xuXHR0aGlzLl90YWdTdGFjay5wb3AoKTtcbn07XG5cbkRvbUhhbmRsZXIucHJvdG90eXBlLm9ucHJvY2Vzc2luZ2luc3RydWN0aW9uID0gZnVuY3Rpb24obmFtZSwgZGF0YSl7XG5cdHZhciBlbGVtZW50ID0gdGhpcy5fY3JlYXRlRG9tRWxlbWVudCh7XG5cdFx0bmFtZTogbmFtZSxcblx0XHRkYXRhOiBkYXRhLFxuXHRcdHR5cGU6IEVsZW1lbnRUeXBlLkRpcmVjdGl2ZVxuXHR9KTtcblxuXHR0aGlzLl9hZGREb21FbGVtZW50KGVsZW1lbnQpO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBEb21IYW5kbGVyO1xuIl19