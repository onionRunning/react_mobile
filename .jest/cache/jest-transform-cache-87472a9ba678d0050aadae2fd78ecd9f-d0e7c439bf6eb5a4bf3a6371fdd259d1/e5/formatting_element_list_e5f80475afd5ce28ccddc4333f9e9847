915b0e6ad84eb46169556d88b61ef2df
'use strict'; //Const

var NOAH_ARK_CAPACITY = 3; //List of formatting elements

var FormattingElementList = module.exports = function (treeAdapter) {
  this.length = 0;
  this.entries = [];
  this.treeAdapter = treeAdapter;
  this.bookmark = null;
}; //Entry types


FormattingElementList.MARKER_ENTRY = 'MARKER_ENTRY';
FormattingElementList.ELEMENT_ENTRY = 'ELEMENT_ENTRY'; //Noah Ark's condition
//OPTIMIZATION: at first we try to find possible candidates for exclusion using
//lightweight heuristics without thorough attributes check.

FormattingElementList.prototype._getNoahArkConditionCandidates = function (newElement) {
  var candidates = [];

  if (this.length >= NOAH_ARK_CAPACITY) {
    var neAttrsLength = this.treeAdapter.getAttrList(newElement).length,
        neTagName = this.treeAdapter.getTagName(newElement),
        neNamespaceURI = this.treeAdapter.getNamespaceURI(newElement);

    for (var i = this.length - 1; i >= 0; i--) {
      var entry = this.entries[i];
      if (entry.type === FormattingElementList.MARKER_ENTRY) break;
      var element = entry.element,
          elementAttrs = this.treeAdapter.getAttrList(element),
          isCandidate = this.treeAdapter.getTagName(element) === neTagName && this.treeAdapter.getNamespaceURI(element) === neNamespaceURI && elementAttrs.length === neAttrsLength;
      if (isCandidate) candidates.push({
        idx: i,
        attrs: elementAttrs
      });
    }
  }

  return candidates.length < NOAH_ARK_CAPACITY ? [] : candidates;
};

FormattingElementList.prototype._ensureNoahArkCondition = function (newElement) {
  var candidates = this._getNoahArkConditionCandidates(newElement),
      cLength = candidates.length;

  if (cLength) {
    var neAttrs = this.treeAdapter.getAttrList(newElement),
        neAttrsLength = neAttrs.length,
        neAttrsMap = Object.create(null); //NOTE: build attrs map for the new element so we can perform fast lookups

    for (var i = 0; i < neAttrsLength; i++) {
      var neAttr = neAttrs[i];
      neAttrsMap[neAttr.name] = neAttr.value;
    }

    for (i = 0; i < neAttrsLength; i++) {
      for (var j = 0; j < cLength; j++) {
        var cAttr = candidates[j].attrs[i];

        if (neAttrsMap[cAttr.name] !== cAttr.value) {
          candidates.splice(j, 1);
          cLength--;
        }

        if (candidates.length < NOAH_ARK_CAPACITY) return;
      }
    } //NOTE: remove bottommost candidates until Noah's Ark condition will not be met


    for (i = cLength - 1; i >= NOAH_ARK_CAPACITY - 1; i--) {
      this.entries.splice(candidates[i].idx, 1);
      this.length--;
    }
  }
}; //Mutations


FormattingElementList.prototype.insertMarker = function () {
  this.entries.push({
    type: FormattingElementList.MARKER_ENTRY
  });
  this.length++;
};

FormattingElementList.prototype.pushElement = function (element, token) {
  this._ensureNoahArkCondition(element);

  this.entries.push({
    type: FormattingElementList.ELEMENT_ENTRY,
    element: element,
    token: token
  });
  this.length++;
};

FormattingElementList.prototype.insertElementAfterBookmark = function (element, token) {
  var bookmarkIdx = this.length - 1;

  for (; bookmarkIdx >= 0; bookmarkIdx--) {
    if (this.entries[bookmarkIdx] === this.bookmark) break;
  }

  this.entries.splice(bookmarkIdx + 1, 0, {
    type: FormattingElementList.ELEMENT_ENTRY,
    element: element,
    token: token
  });
  this.length++;
};

FormattingElementList.prototype.removeEntry = function (entry) {
  for (var i = this.length - 1; i >= 0; i--) {
    if (this.entries[i] === entry) {
      this.entries.splice(i, 1);
      this.length--;
      break;
    }
  }
};

FormattingElementList.prototype.clearToLastMarker = function () {
  while (this.length) {
    var entry = this.entries.pop();
    this.length--;
    if (entry.type === FormattingElementList.MARKER_ENTRY) break;
  }
}; //Search


FormattingElementList.prototype.getElementEntryInScopeWithTagName = function (tagName) {
  for (var i = this.length - 1; i >= 0; i--) {
    var entry = this.entries[i];
    if (entry.type === FormattingElementList.MARKER_ENTRY) return null;
    if (this.treeAdapter.getTagName(entry.element) === tagName) return entry;
  }

  return null;
};

FormattingElementList.prototype.getElementEntry = function (element) {
  for (var i = this.length - 1; i >= 0; i--) {
    var entry = this.entries[i];
    if (entry.type === FormattingElementList.ELEMENT_ENTRY && entry.element === element) return entry;
  }

  return null;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZvcm1hdHRpbmdfZWxlbWVudF9saXN0LmpzIl0sIm5hbWVzIjpbIk5PQUhfQVJLX0NBUEFDSVRZIiwiRm9ybWF0dGluZ0VsZW1lbnRMaXN0IiwibW9kdWxlIiwiZXhwb3J0cyIsInRyZWVBZGFwdGVyIiwibGVuZ3RoIiwiZW50cmllcyIsImJvb2ttYXJrIiwiTUFSS0VSX0VOVFJZIiwiRUxFTUVOVF9FTlRSWSIsInByb3RvdHlwZSIsIl9nZXROb2FoQXJrQ29uZGl0aW9uQ2FuZGlkYXRlcyIsIm5ld0VsZW1lbnQiLCJjYW5kaWRhdGVzIiwibmVBdHRyc0xlbmd0aCIsImdldEF0dHJMaXN0IiwibmVUYWdOYW1lIiwiZ2V0VGFnTmFtZSIsIm5lTmFtZXNwYWNlVVJJIiwiZ2V0TmFtZXNwYWNlVVJJIiwiaSIsImVudHJ5IiwidHlwZSIsImVsZW1lbnQiLCJlbGVtZW50QXR0cnMiLCJpc0NhbmRpZGF0ZSIsInB1c2giLCJpZHgiLCJhdHRycyIsIl9lbnN1cmVOb2FoQXJrQ29uZGl0aW9uIiwiY0xlbmd0aCIsIm5lQXR0cnMiLCJuZUF0dHJzTWFwIiwiT2JqZWN0IiwiY3JlYXRlIiwibmVBdHRyIiwibmFtZSIsInZhbHVlIiwiaiIsImNBdHRyIiwic3BsaWNlIiwiaW5zZXJ0TWFya2VyIiwicHVzaEVsZW1lbnQiLCJ0b2tlbiIsImluc2VydEVsZW1lbnRBZnRlckJvb2ttYXJrIiwiYm9va21hcmtJZHgiLCJyZW1vdmVFbnRyeSIsImNsZWFyVG9MYXN0TWFya2VyIiwicG9wIiwiZ2V0RWxlbWVudEVudHJ5SW5TY29wZVdpdGhUYWdOYW1lIiwidGFnTmFtZSIsImdldEVsZW1lbnRFbnRyeSJdLCJtYXBwaW5ncyI6IkFBQUEsYSxDQUVBOztBQUNBLElBQUlBLGlCQUFpQixHQUFHLENBQXhCLEMsQ0FFQTs7QUFDQSxJQUFJQyxxQkFBcUIsR0FBR0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLFVBQVVDLFdBQVYsRUFBdUI7QUFDaEUsT0FBS0MsTUFBTCxHQUFjLENBQWQ7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cUIsQ0FBQ1EsYUFBckMsSUFBc0RZLEtBQUssQ0FBQ0UsT0FBTixLQUFrQkEsT0FBNUUsRUFDSSxPQUFPRixLQUFQO0FBQ1A7O0FBRUQsU0FBTyxJQUFQO0FBQ0gsQ0FURCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuLy9Db25zdFxudmFyIE5PQUhfQVJLX0NBUEFDSVRZID0gMztcblxuLy9MaXN0IG9mIGZvcm1hdHRpbmcgZWxlbWVudHNcbnZhciBGb3JtYXR0aW5nRWxlbWVudExpc3QgPSBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh0cmVlQWRhcHRlcikge1xuICAgIHRoaXMubGVuZ3RoID0gMDtcbiAgICB0aGlzLmVudHJpZXMgPSBbXTtcbiAgICB0aGlzLnRyZWVBZGFwdGVyID0gdHJlZUFkYXB0ZXI7XG4gICAgdGhpcy5ib29rbWFyayA9IG51bGw7XG59O1xuXG4vL0VudHJ5IHR5cGVzXG5Gb3JtYXR0aW5nRWxlbWVudExpc3QuTUFSS0VSX0VOVFJZID0gJ01BUktFUl9FTlRSWSc7XG5Gb3JtYXR0aW5nRWxlbWVudExpc3QuRUxFTUVOVF9FTlRSWSA9ICdFTEVNRU5UX0VOVFJZJztcblxuLy9Ob2FoIEFyaydzIGNvbmRpdGlvblxuLy9PUFRJTUlaQVRJT046IGF0IGZpcnN0IHdlIHRyeSB0byBmaW5kIHBvc3NpYmxlIGNhbmRpZGF0ZXMgZm9yIGV4Y2x1c2lvbiB1c2luZ1xuLy9saWdodHdlaWdodCBoZXVyaXN0aWNzIHdpdGhvdXQgdGhvcm91Z2ggYXR0cmlidXRlcyBjaGVjay5cbkZvcm1hdHRpbmdFbGVtZW50TGlzdC5wcm90b3R5cGUuX2dldE5vYWhBcmtDb25kaXRpb25DYW5kaWRhdGVzID0gZnVuY3Rpb24gKG5ld0VsZW1lbnQpIHtcbiAgICB2YXIgY2FuZGlkYXRlcyA9IFtdO1xuXG4gICAgaWYgKHRoaXMubGVuZ3RoID49IE5PQUhfQVJLX0NBUEFDSVRZKSB7XG4gICAgICAgIHZhciBuZUF0dHJzTGVuZ3RoID0gdGhpcy50cmVlQWRhcHRlci5nZXRBdHRyTGlzdChuZXdFbGVtZW50KS5sZW5ndGgsXG4gICAgICAgICAgICBuZVRhZ05hbWUgPSB0aGlzLnRyZWVBZGFwdGVyLmdldFRhZ05hbWUobmV3RWxlbWVudCksXG4gICAgICAgICAgICBuZU5hbWVzcGFjZVVSSSA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0TmFtZXNwYWNlVVJJKG5ld0VsZW1lbnQpO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICB2YXIgZW50cnkgPSB0aGlzLmVudHJpZXNbaV07XG5cbiAgICAgICAgICAgIGlmIChlbnRyeS50eXBlID09PSBGb3JtYXR0aW5nRWxlbWVudExpc3QuTUFSS0VSX0VOVFJZKVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICB2YXIgZWxlbWVudCA9IGVudHJ5LmVsZW1lbnQsXG4gICAgICAgICAgICAgICAgZWxlbWVudEF0dHJzID0gdGhpcy50cmVlQWRhcHRlci5nZXRBdHRyTGlzdChlbGVtZW50KSxcbiAgICAgICAgICAgICAgICBpc0NhbmRpZGF0ZSA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0VGFnTmFtZShlbGVtZW50KSA9PT0gbmVUYWdOYW1lICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyZWVBZGFwdGVyLmdldE5hbWVzcGFjZVVSSShlbGVtZW50KSA9PT0gbmVOYW1lc3BhY2VVUkkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRBdHRycy5sZW5ndGggPT09IG5lQXR0cnNMZW5ndGg7XG5cbiAgICAgICAgICAgIGlmIChpc0NhbmRpZGF0ZSlcbiAgICAgICAgICAgICAgICBjYW5kaWRhdGVzLnB1c2goe2lkeDogaSwgYXR0cnM6IGVsZW1lbnRBdHRyc30pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGNhbmRpZGF0ZXMubGVuZ3RoIDwgTk9BSF9BUktfQ0FQQUNJVFkgPyBbXSA6IGNhbmRpZGF0ZXM7XG59O1xuXG5Gb3JtYXR0aW5nRWxlbWVudExpc3QucHJvdG90eXBlLl9lbnN1cmVOb2FoQXJrQ29uZGl0aW9uID0gZnVuY3Rpb24gKG5ld0VsZW1lbnQpIHtcbiAgICB2YXIgY2FuZGlkYXRlcyA9IHRoaXMuX2dldE5vYWhBcmtDb25kaXRpb25DYW5kaWRhdGVzKG5ld0VsZW1lbnQpLFxuICAgICAgICBjTGVuZ3RoID0gY2FuZGlkYXRlcy5sZW5ndGg7XG5cbiAgICBpZiAoY0xlbmd0aCkge1xuICAgICAgICB2YXIgbmVBdHRycyA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0QXR0ckxpc3QobmV3RWxlbWVudCksXG4gICAgICAgICAgICBuZUF0dHJzTGVuZ3RoID0gbmVBdHRycy5sZW5ndGgsXG4gICAgICAgICAgICBuZUF0dHJzTWFwID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgICAgICAvL05PVEU6IGJ1aWxkIGF0dHJzIG1hcCBmb3IgdGhlIG5ldyBlbGVtZW50IHNvIHdlIGNhbiBwZXJmb3JtIGZhc3QgbG9va3Vwc1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5lQXR0cnNMZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdmFyIG5lQXR0ciA9IG5lQXR0cnNbaV07XG5cbiAgICAgICAgICAgIG5lQXR0cnNNYXBbbmVBdHRyLm5hbWVdID0gbmVBdHRyLnZhbHVlO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChpID0gMDsgaSA8IG5lQXR0cnNMZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjTGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgY0F0dHIgPSBjYW5kaWRhdGVzW2pdLmF0dHJzW2ldO1xuXG4gICAgICAgICAgICAgICAgaWYgKG5lQXR0cnNNYXBbY0F0dHIubmFtZV0gIT09IGNBdHRyLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbmRpZGF0ZXMuc3BsaWNlKGosIDEpO1xuICAgICAgICAgICAgICAgICAgICBjTGVuZ3RoLS07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZXMubGVuZ3RoIDwgTk9BSF9BUktfQ0FQQUNJVFkpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vTk9URTogcmVtb3ZlIGJvdHRvbW1vc3QgY2FuZGlkYXRlcyB1bnRpbCBOb2FoJ3MgQXJrIGNvbmRpdGlvbiB3aWxsIG5vdCBiZSBtZXRcbiAgICAgICAgZm9yIChpID0gY0xlbmd0aCAtIDE7IGkgPj0gTk9BSF9BUktfQ0FQQUNJVFkgLSAxOyBpLS0pIHtcbiAgICAgICAgICAgIHRoaXMuZW50cmllcy5zcGxpY2UoY2FuZGlkYXRlc1tpXS5pZHgsIDEpO1xuICAgICAgICAgICAgdGhpcy5sZW5ndGgtLTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbi8vTXV0YXRpb25zXG5Gb3JtYXR0aW5nRWxlbWVudExpc3QucHJvdG90eXBlLmluc2VydE1hcmtlciA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmVudHJpZXMucHVzaCh7dHlwZTogRm9ybWF0dGluZ0VsZW1lbnRMaXN0Lk1BUktFUl9FTlRSWX0pO1xuICAgIHRoaXMubGVuZ3RoKys7XG59O1xuXG5Gb3JtYXR0aW5nRWxlbWVudExpc3QucHJvdG90eXBlLnB1c2hFbGVtZW50ID0gZnVuY3Rpb24gKGVsZW1lbnQsIHRva2VuKSB7XG4gICAgdGhpcy5fZW5zdXJlTm9haEFya0NvbmRpdGlvbihlbGVtZW50KTtcblxuICAgIHRoaXMuZW50cmllcy5wdXNoKHtcbiAgICAgICAgdHlwZTogRm9ybWF0dGluZ0VsZW1lbnRMaXN0LkVMRU1FTlRfRU5UUlksXG4gICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsXG4gICAgICAgIHRva2VuOiB0b2tlblxuICAgIH0pO1xuXG4gICAgdGhpcy5sZW5ndGgrKztcbn07XG5cbkZvcm1hdHRpbmdFbGVtZW50TGlzdC5wcm90b3R5cGUuaW5zZXJ0RWxlbWVudEFmdGVyQm9va21hcmsgPSBmdW5jdGlvbiAoZWxlbWVudCwgdG9rZW4pIHtcbiAgICB2YXIgYm9va21hcmtJZHggPSB0aGlzLmxlbmd0aCAtIDE7XG5cbiAgICBmb3IgKDsgYm9va21hcmtJZHggPj0gMDsgYm9va21hcmtJZHgtLSkge1xuICAgICAgICBpZiAodGhpcy5lbnRyaWVzW2Jvb2ttYXJrSWR4XSA9PT0gdGhpcy5ib29rbWFyaylcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHRoaXMuZW50cmllcy5zcGxpY2UoYm9va21hcmtJZHggKyAxLCAwLCB7XG4gICAgICAgIHR5cGU6IEZvcm1hdHRpbmdFbGVtZW50TGlzdC5FTEVNRU5UX0VOVFJZLFxuICAgICAgICBlbGVtZW50OiBlbGVtZW50LFxuICAgICAgICB0b2tlbjogdG9rZW5cbiAgICB9KTtcblxuICAgIHRoaXMubGVuZ3RoKys7XG59O1xuXG5Gb3JtYXR0aW5nRWxlbWVudExpc3QucHJvdG90eXBlLnJlbW92ZUVudHJ5ID0gZnVuY3Rpb24gKGVudHJ5KSB7XG4gICAgZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgaWYgKHRoaXMuZW50cmllc1tpXSA9PT0gZW50cnkpIHtcbiAgICAgICAgICAgIHRoaXMuZW50cmllcy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICB0aGlzLmxlbmd0aC0tO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5Gb3JtYXR0aW5nRWxlbWVudExpc3QucHJvdG90eXBlLmNsZWFyVG9MYXN0TWFya2VyID0gZnVuY3Rpb24gKCkge1xuICAgIHdoaWxlICh0aGlzLmxlbmd0aCkge1xuICAgICAgICB2YXIgZW50cnkgPSB0aGlzLmVudHJpZXMucG9wKCk7XG5cbiAgICAgICAgdGhpcy5sZW5ndGgtLTtcblxuICAgICAgICBpZiAoZW50cnkudHlwZSA9PT0gRm9ybWF0dGluZ0VsZW1lbnRMaXN0Lk1BUktFUl9FTlRSWSlcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cbn07XG5cbi8vU2VhcmNoXG5Gb3JtYXR0aW5nRWxlbWVudExpc3QucHJvdG90eXBlLmdldEVsZW1lbnRFbnRyeUluU2NvcGVXaXRoVGFnTmFtZSA9IGZ1bmN0aW9uICh0YWdOYW1lKSB7XG4gICAgZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgdmFyIGVudHJ5ID0gdGhpcy5lbnRyaWVzW2ldO1xuXG4gICAgICAgIGlmIChlbnRyeS50eXBlID09PSBGb3JtYXR0aW5nRWxlbWVudExpc3QuTUFSS0VSX0VOVFJZKVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgaWYgKHRoaXMudHJlZUFkYXB0ZXIuZ2V0VGFnTmFtZShlbnRyeS5lbGVtZW50KSA9PT0gdGFnTmFtZSlcbiAgICAgICAgICAgIHJldHVybiBlbnRyeTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbn07XG5cbkZvcm1hdHRpbmdFbGVtZW50TGlzdC5wcm90b3R5cGUuZ2V0RWxlbWVudEVudHJ5ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICBmb3IgKHZhciBpID0gdGhpcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICB2YXIgZW50cnkgPSB0aGlzLmVudHJpZXNbaV07XG5cbiAgICAgICAgaWYgKGVudHJ5LnR5cGUgPT09IEZvcm1hdHRpbmdFbGVtZW50TGlzdC5FTEVNRU5UX0VOVFJZICYmIGVudHJ5LmVsZW1lbnQgPT09IGVsZW1lbnQpXG4gICAgICAgICAgICByZXR1cm4gZW50cnk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG59O1xuIl19