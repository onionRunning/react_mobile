e22b9c469812fe3e27f98a346c28d9b7
'use strict';

var Mixin = require('../../utils/mixin'),
    Tokenizer = require('../../tokenizer'),
    LocationInfoTokenizerMixin = require('./tokenizer_mixin'),
    PositionTrackingPreprocessorMixin = require('../position_tracking/preprocessor_mixin'),
    LocationInfoOpenElementStackMixin = require('./open_element_stack_mixin'),
    HTML = require('../../common/html'),
    inherits = require('util').inherits; //Aliases


var $ = HTML.TAG_NAMES;

var LocationInfoParserMixin = module.exports = function (parser) {
  Mixin.call(this, parser);
  this.parser = parser;
  this.posTracker = null;
  this.lastStartTagToken = null;
  this.lastFosterParentingLocation = null;
  this.currentToken = null;
};

inherits(LocationInfoParserMixin, Mixin);

LocationInfoParserMixin.prototype._setStartLocation = function (element) {
  if (this.lastStartTagToken) {
    element.__location = Object.create(this.lastStartTagToken.location);
    element.__location.startTag = this.lastStartTagToken.location;
  } else element.__location = null;
};

LocationInfoParserMixin.prototype._setEndLocation = function (element, closingToken) {
  var loc = element.__location;

  if (loc) {
    if (closingToken.location) {
      var ctLoc = closingToken.location,
          tn = this.parser.treeAdapter.getTagName(element); // NOTE: For cases like <p> <p> </p> - First 'p' closes without a closing
      // tag and for cases like <td> <p> </td> - 'p' closes without a closing tag.

      var isClosingEndTag = closingToken.type === Tokenizer.END_TAG_TOKEN && tn === closingToken.tagName;

      if (isClosingEndTag) {
        loc.endTag = Object.create(ctLoc);
        loc.endOffset = ctLoc.endOffset;
      } else loc.endOffset = ctLoc.startOffset;
    } else if (closingToken.type === Tokenizer.EOF_TOKEN) loc.endOffset = this.posTracker.offset;
  }
};

LocationInfoParserMixin.prototype._getOverriddenMethods = function (mxn, orig) {
  return {
    _bootstrap: function (document, fragmentContext) {
      orig._bootstrap.call(this, document, fragmentContext);

      mxn.lastStartTagToken = null;
      mxn.lastFosterParentingLocation = null;
      mxn.currentToken = null;
      mxn.posTracker = new PositionTrackingPreprocessorMixin(this.tokenizer.preprocessor);
      new LocationInfoTokenizerMixin(this.tokenizer);
      new LocationInfoOpenElementStackMixin(this.openElements, {
        onItemPop: function (element) {
          mxn._setEndLocation(element, mxn.currentToken);
        }
      });
    },
    _runParsingLoop: function (scriptHandler) {
      orig._runParsingLoop.call(this, scriptHandler); // NOTE: generate location info for elements
      // that remains on open element stack


      for (var i = this.openElements.stackTop; i >= 0; i--) mxn._setEndLocation(this.openElements.items[i], mxn.currentToken);
    },
    //Token processing
    _processTokenInForeignContent: function (token) {
      mxn.currentToken = token;

      orig._processTokenInForeignContent.call(this, token);
    },
    _processToken: function (token) {
      mxn.currentToken = token;

      orig._processToken.call(this, token); //NOTE: <body> and <html> are never popped from the stack, so we need to updated
      //their end location explicitly.


      var requireExplicitUpdate = token.type === Tokenizer.END_TAG_TOKEN && (token.tagName === $.HTML || token.tagName === $.BODY && this.openElements.hasInScope($.BODY));

      if (requireExplicitUpdate) {
        for (var i = this.openElements.stackTop; i >= 0; i--) {
          var element = this.openElements.items[i];

          if (this.treeAdapter.getTagName(element) === token.tagName) {
            mxn._setEndLocation(element, token);

            break;
          }
        }
      }
    },
    //Doctype
    _setDocumentType: function (token) {
      orig._setDocumentType.call(this, token);

      var documentChildren = this.treeAdapter.getChildNodes(this.document),
          cnLength = documentChildren.length;

      for (var i = 0; i < cnLength; i++) {
        var node = documentChildren[i];

        if (this.treeAdapter.isDocumentTypeNode(node)) {
          node.__location = token.location;
          break;
        }
      }
    },
    //Elements
    _attachElementToTree: function (element) {
      //NOTE: _attachElementToTree is called from _appendElement, _insertElement and _insertTemplate methods.
      //So we will use token location stored in this methods for the element.
      mxn._setStartLocation(element);

      mxn.lastStartTagToken = null;

      orig._attachElementToTree.call(this, element);
    },
    _appendElement: function (token, namespaceURI) {
      mxn.lastStartTagToken = token;

      orig._appendElement.call(this, token, namespaceURI);
    },
    _insertElement: function (token, namespaceURI) {
      mxn.lastStartTagToken = token;

      orig._insertElement.call(this, token, namespaceURI);
    },
    _insertTemplate: function (token) {
      mxn.lastStartTagToken = token;

      orig._insertTemplate.call(this, token);

      var tmplContent = this.treeAdapter.getTemplateContent(this.openElements.current);
      tmplContent.__location = null;
    },
    _insertFakeRootElement: function () {
      orig._insertFakeRootElement.call(this);

      this.openElements.current.__location = null;
    },
    //Comments
    _appendCommentNode: function (token, parent) {
      orig._appendCommentNode.call(this, token, parent);

      var children = this.treeAdapter.getChildNodes(parent),
          commentNode = children[children.length - 1];
      commentNode.__location = token.location;
    },
    //Text
    _findFosterParentingLocation: function () {
      //NOTE: store last foster parenting location, so we will be able to find inserted text
      //in case of foster parenting
      mxn.lastFosterParentingLocation = orig._findFosterParentingLocation.call(this);
      return mxn.lastFosterParentingLocation;
    },
    _insertCharacters: function (token) {
      orig._insertCharacters.call(this, token);

      var hasFosterParent = this._shouldFosterParentOnInsertion(),
          parent = hasFosterParent && mxn.lastFosterParentingLocation.parent || this.openElements.currentTmplContent || this.openElements.current,
          siblings = this.treeAdapter.getChildNodes(parent),
          textNodeIdx = hasFosterParent && mxn.lastFosterParentingLocation.beforeElement ? siblings.indexOf(mxn.lastFosterParentingLocation.beforeElement) - 1 : siblings.length - 1,
          textNode = siblings[textNodeIdx]; //NOTE: if we have location assigned by another token, then just update end position


      if (textNode.__location) textNode.__location.endOffset = token.location.endOffset;else textNode.__location = token.location;
    }
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlcl9taXhpbi5qcyJdLCJuYW1lcyI6WyJNaXhpbiIsInJlcXVpcmUiLCJUb2tlbml6ZXIiLCJMb2NhdGlvbkluZm9Ub2tlbml6ZXJNaXhpbiIsIlBvc2l0aW9uVHJhY2tpbmdQcmVwcm9jZXNzb3JNaXhpbiIsIkxvY2F0aW9uSW5mb09wZW5FbGVtZW50U3RhY2tNaXhpbiIsIkhUTUwiLCJpbmhlcml0cyIsIiQiLCJUQUdfTkFNRVMiLCJMb2NhdGlvbkluZm9QYXJzZXJNaXhpbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJwYXJzZXIiLCJjYWxsIiwicG9zVHJhY2tlciIsImxhc3RTdGFydFRhZ1Rva2VuIiwibGFzdEZvc3RlclBhcmVudGluZ0xvY2F0aW9uIiwiY3VycmVudFRva2VuIiwicHJvdG90eXBlIiwiX3NldFN0YXJ0TG9jYXRpb24iLCJlbGVtZW50IiwiX19sb2NhdGlvbiIsIk9iamVjdCIsImNyZWF0ZSIsImxvY2F0aW9uIiwic3RhcnRUYWciLCJfc2V0RW5kTG9jYXRpb24iLCJjbG9zaW5nVG9rZW4iLCJsb2MiLCJjdExvYyIsInRuIiwidHJlZUFkYXB0ZXIiLCJnZXRUYWdOYW1lIiwiaXNDbG9zaW5nRW5kVGFnIiwidHlwZSIsIkVORF9UQUdfVE9LRU4iLCJ0YWdOYW1lIiwiZW5kVGFnIiwiZW5kT2Zmc2V0Iiwic3RhcnRPZmZzZXQiLCJFT0ZfVE9LRU4iLCJvZmZzZXQiLCJfZ2V0T3ZlcnJpZGRlbk1ldGhvZHMiLCJteG4iLCJvcmlnIiwiX2Jvb3RzdHJhcCIsImRvY3VtZW50IiwiZnJhZ21lbnRDb250ZXh0IiwidG9rZW5pemVyIiwicHJlcHJvY2Vzc29yIiwib3BlbkVsZW1lbnRzIiwib25JdGVtUG9wIiwiX3J1blBhcnNpbmdMb29wIiwic2NyaXB0SGFuZGxlciIsImkiLCJzdGFja1RvcCIsIml0ZW1zIiwiX3Byb2Nlc3NUb2tlbkluRm9yZWlnbkNvbnRlbnQiLCJ0b2tlbiIsIl9wcm9jZXNzVG9rZW4iLCJyZXF1aXJlRXhwbGljaXRVcGRhdGUiLCJCT0RZIiwiaGFzSW5TY29wZSIsIl9zZXREb2N1bWVudFR5cGUiLCJkb2N1bWVudENoaWxkcmVuIiwiZ2V0Q2hpbGROb2RlcyIsImNuTGVuZ3RoIiwibGVuZ3RoIiwibm9kZSIsImlzRG9jdW1lbnRUeXBlTm9kZSIsIl9hdHRhY2hFbGVtZW50VG9UcmVlIiwiX2FwcGVuZEVsZW1lbnQiLCJuYW1lc3BhY2VVUkkiLCJfaW5zZXJ0RWxlbWVudCIsIl9pbnNlcnRUZW1wbGF0ZSIsInRtcGxDb250ZW50IiwiZ2V0VGVtcGxhdGVDb250ZW50IiwiY3VycmVudCIsIl9pbnNlcnRGYWtlUm9vdEVsZW1lbnQiLCJfYXBwZW5kQ29tbWVudE5vZGUiLCJwYXJlbnQiLCJjaGlsZHJlbiIsImNvbW1lbnROb2RlIiwiX2ZpbmRGb3N0ZXJQYXJlbnRpbmdMb2NhdGlvbiIsIl9pbnNlcnRDaGFyYWN0ZXJzIiwiaGFzRm9zdGVyUGFyZW50IiwiX3Nob3VsZEZvc3RlclBhcmVudE9uSW5zZXJ0aW9uIiwiY3VycmVudFRtcGxDb250ZW50Iiwic2libGluZ3MiLCJ0ZXh0Tm9kZUlkeCIsImJlZm9yZUVsZW1lbnQiLCJpbmRleE9mIiwidGV4dE5vZGUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLEtBQUssR0FBR0MsT0FBTyxDQUFDLG1CQUFELENBQW5CO0FBQUEsSUFDSUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsaUJBQUQsQ0FEdkI7QUFBQSxJQUVJRSwwQkFBMEIsR0FBR0YsT0FBTyxDQUFDLG1CQUFELENBRnhDO0FBQUEsSUFHSUcsaUNBQWlDLEdBQUdILE9BQU8sQ0FBQyx5Q0FBRCxDQUgvQztBQUFBLElBSUlJLGlDQUFpQyxHQUFHSixPQUFPLENBQUMsNEJBQUQsQ0FKL0M7QUFBQSxJQUtJSyxJQUFJLEdBQUdMLE9BQU8sQ0FBQyxtQkFBRCxDQUxsQjtBQUFBLElBTUlNLFFBQVEsR0FBR04sT0FBTyxDQUFDLE1BQUQsQ0FBUCxDQUFnQk0sUUFOL0IsQyxDQVNBOzs7QUFDQSxJQUFJQyxDQUFDLEdB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QUFBQSxpQkFBaUIsRUFBRSxVQUFVMUIsS0FBVixFQUFpQjtBQUNoQ2QsTUFBQUEsSUFBSSxDQUFDd0MsaUJBQUwsQ0FBdUJ2RSxJQUF2QixDQUE0QixJQUE1QixFQUFrQzZDLEtBQWxDOztBQUVBLFVBQUkyQixlQUFlLEdBQUcsS0FBS0MsOEJBQUwsRUFBdEI7QUFBQSxVQUNJTixNQUFNLEdBQUdLLGVBQWUsSUFBSTFDLEdBQUcsQ0FBQzNCLDJCQUFKLENBQWdDZ0UsTUFBbkQsSUFDQSxLQUFLOUIsWUFBTCxDQUFrQnFDLGtCQURsQixJQUVBLEtBQUtyQyxZQUFMLENBQWtCMkIsT0FIL0I7QUFBQSxVQUlJVyxRQUFRLEdBQUcsS0FBS3pELFdBQUwsQ0FBaUJrQyxhQUFqQixDQUErQmUsTUFBL0IsQ0FKZjtBQUFBLFVBS0lTLFdBQVcsR0FBR0osZUFBZSxJQUFJMUMsR0FBRyxDQUFDM0IsMkJBQUosQ0FBZ0MwRSxhQUFuRCxHQUNkRixRQUFRLENBQUNHLE9BQVQsQ0FBaUJoRCxHQUFHLENBQUMzQiwyQkFBSixDQUFnQzBFLGFBQWpELElBQWtFLENBRHBELEdBRWRGLFFBQVEsQ0FBQ3JCLE1BQVQsR0FBa0IsQ0FQdEI7QUFBQSxVQVFJeUIsUUFBUSxHQUFHSixRQUFRLENBQUNDLFdBQUQsQ0FSdkIsQ0FIZ0MsQ0FhaEM7OztBQUNBLFVBQUlHLFFBQVEsQ0FBQ3ZFLFVBQWIsRUFDSXVFLFFBQVEsQ0FBQ3ZFLFVBQVQsQ0FBb0JpQixTQUFwQixHQUFnQ29CLEtBQUssQ0FBQ2xDLFFBQU4sQ0FBZWMsU0FBL0MsQ0FESixLQUlJc0QsUUFBUSxDQUFDdkUsVUFBVCxHQUFzQnFDLEtBQUssQ0FBQ2xDLFFBQTVCO0FBQ1A7QUFsSkUsR0FBUDtBQW9KSCxDQXJKRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIE1peGluID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvbWl4aW4nKSxcbiAgICBUb2tlbml6ZXIgPSByZXF1aXJlKCcuLi8uLi90b2tlbml6ZXInKSxcbiAgICBMb2NhdGlvbkluZm9Ub2tlbml6ZXJNaXhpbiA9IHJlcXVpcmUoJy4vdG9rZW5pemVyX21peGluJyksXG4gICAgUG9zaXRpb25UcmFja2luZ1ByZXByb2Nlc3Nvck1peGluID0gcmVxdWlyZSgnLi4vcG9zaXRpb25fdHJhY2tpbmcvcHJlcHJvY2Vzc29yX21peGluJyksXG4gICAgTG9jYXRpb25JbmZvT3BlbkVsZW1lbnRTdGFja01peGluID0gcmVxdWlyZSgnLi9vcGVuX2VsZW1lbnRfc3RhY2tfbWl4aW4nKSxcbiAgICBIVE1MID0gcmVxdWlyZSgnLi4vLi4vY29tbW9uL2h0bWwnKSxcbiAgICBpbmhlcml0cyA9IHJlcXVpcmUoJ3V0aWwnKS5pbmhlcml0cztcblxuXG4vL0FsaWFzZXNcbnZhciAkID0gSFRNTC5UQUdfTkFNRVM7XG5cbnZhciBMb2NhdGlvbkluZm9QYXJzZXJNaXhpbiA9IG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHBhcnNlcikge1xuICAgIE1peGluLmNhbGwodGhpcywgcGFyc2VyKTtcblxuICAgIHRoaXMucGFyc2VyID0gcGFyc2VyO1xuICAgIHRoaXMucG9zVHJhY2tlciA9IG51bGw7XG4gICAgdGhpcy5sYXN0U3RhcnRUYWdUb2tlbiA9IG51bGw7XG4gICAgdGhpcy5sYXN0Rm9zdGVyUGFyZW50aW5nTG9jYXRpb24gPSBudWxsO1xuICAgIHRoaXMuY3VycmVudFRva2VuID0gbnVsbDtcbn07XG5cbmluaGVyaXRzKExvY2F0aW9uSW5mb1BhcnNlck1peGluLCBNaXhpbik7XG5cblxuTG9jYXRpb25JbmZvUGFyc2VyTWl4aW4ucHJvdG90eXBlLl9zZXRTdGFydExvY2F0aW9uID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICBpZiAodGhpcy5sYXN0U3RhcnRUYWdUb2tlbikge1xuICAgICAgICBlbGVtZW50Ll9fbG9jYXRpb24gPSBPYmplY3QuY3JlYXRlKHRoaXMubGFzdFN0YXJ0VGFnVG9rZW4ubG9jYXRpb24pO1xuICAgICAgICBlbGVtZW50Ll9fbG9jYXRpb24uc3RhcnRUYWcgPSB0aGlzLmxhc3RTdGFydFRhZ1Rva2VuLmxvY2F0aW9uO1xuICAgIH1cbiAgICBlbHNlXG4gICAgICAgIGVsZW1lbnQuX19sb2NhdGlvbiA9IG51bGw7XG59O1xuXG5Mb2NhdGlvbkluZm9QYXJzZXJNaXhpbi5wcm90b3R5cGUuX3NldEVuZExvY2F0aW9uID0gZnVuY3Rpb24gKGVsZW1lbnQsIGNsb3NpbmdUb2tlbikge1xuICAgIHZhciBsb2MgPSBlbGVtZW50Ll9fbG9jYXRpb247XG5cbiAgICBpZiAobG9jKSB7XG4gICAgICAgIGlmIChjbG9zaW5nVG9rZW4ubG9jYXRpb24pIHtcbiAgICAgICAgICAgIHZhciBjdExvYyA9IGNsb3NpbmdUb2tlbi5sb2NhdGlvbixcbiAgICAgICAgICAgICAgICB0biA9IHRoaXMucGFyc2VyLnRyZWVBZGFwdGVyLmdldFRhZ05hbWUoZWxlbWVudCk7XG5cbiAgICAgICAgICAgIC8vIE5PVEU6IEZvciBjYXNlcyBsaWtlIDxwPiA8cD4gPC9wPiAtIEZpcnN0ICdwJyBjbG9zZXMgd2l0aG91dCBhIGNsb3NpbmdcbiAgICAgICAgICAgIC8vIHRhZyBhbmQgZm9yIGNhc2VzIGxpa2UgPHRkPiA8cD4gPC90ZD4gLSAncCcgY2xvc2VzIHdpdGhvdXQgYSBjbG9zaW5nIHRhZy5cbiAgICAgICAgICAgIHZhciBpc0Nsb3NpbmdFbmRUYWcgPSBjbG9zaW5nVG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLkVORF9UQUdfVE9LRU4gJiYgdG4gPT09IGNsb3NpbmdUb2tlbi50YWdOYW1lO1xuXG4gICAgICAgICAgICBpZiAoaXNDbG9zaW5nRW5kVGFnKSB7XG4gICAgICAgICAgICAgICAgbG9jLmVuZFRhZyA9IE9iamVjdC5jcmVhdGUoY3RMb2MpO1xuICAgICAgICAgICAgICAgIGxvYy5lbmRPZmZzZXQgPSBjdExvYy5lbmRPZmZzZXQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBsb2MuZW5kT2Zmc2V0ID0gY3RMb2Muc3RhcnRPZmZzZXQ7XG4gICAgICAgIH1cblxuICAgICAgICBlbHNlIGlmIChjbG9zaW5nVG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLkVPRl9UT0tFTilcbiAgICAgICAgICAgIGxvYy5lbmRPZmZzZXQgPSB0aGlzLnBvc1RyYWNrZXIub2Zmc2V0O1xuICAgIH1cbn07XG5cbkxvY2F0aW9uSW5mb1BhcnNlck1peGluLnByb3RvdHlwZS5fZ2V0T3ZlcnJpZGRlbk1ldGhvZHMgPSBmdW5jdGlvbiAobXhuLCBvcmlnKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgX2Jvb3RzdHJhcDogZnVuY3Rpb24gKGRvY3VtZW50LCBmcmFnbWVudENvbnRleHQpIHtcbiAgICAgICAgICAgIG9yaWcuX2Jvb3RzdHJhcC5jYWxsKHRoaXMsIGRvY3VtZW50LCBmcmFnbWVudENvbnRleHQpO1xuXG4gICAgICAgICAgICBteG4ubGFzdFN0YXJ0VGFnVG9rZW4gPSBudWxsO1xuICAgICAgICAgICAgbXhuLmxhc3RGb3N0ZXJQYXJlbnRpbmdMb2NhdGlvbiA9IG51bGw7XG4gICAgICAgICAgICBteG4uY3VycmVudFRva2VuID0gbnVsbDtcbiAgICAgICAgICAgIG14bi5wb3NUcmFja2VyID0gbmV3IFBvc2l0aW9uVHJhY2tpbmdQcmVwcm9jZXNzb3JNaXhpbih0aGlzLnRva2VuaXplci5wcmVwcm9jZXNzb3IpO1xuXG4gICAgICAgICAgICBuZXcgTG9jYXRpb25JbmZvVG9rZW5pemVyTWl4aW4odGhpcy50b2tlbml6ZXIpO1xuXG4gICAgICAgICAgICBuZXcgTG9jYXRpb25JbmZvT3BlbkVsZW1lbnRTdGFja01peGluKHRoaXMub3BlbkVsZW1lbnRzLCB7XG4gICAgICAgICAgICAgICAgb25JdGVtUG9wOiBmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICBteG4uX3NldEVuZExvY2F0aW9uKGVsZW1lbnQsIG14bi5jdXJyZW50VG9rZW4pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9ydW5QYXJzaW5nTG9vcDogZnVuY3Rpb24gKHNjcmlwdEhhbmRsZXIpIHtcbiAgICAgICAgICAgIG9yaWcuX3J1blBhcnNpbmdMb29wLmNhbGwodGhpcywgc2NyaXB0SGFuZGxlcik7XG5cbiAgICAgICAgICAgIC8vIE5PVEU6IGdlbmVyYXRlIGxvY2F0aW9uIGluZm8gZm9yIGVsZW1lbnRzXG4gICAgICAgICAgICAvLyB0aGF0IHJlbWFpbnMgb24gb3BlbiBlbGVtZW50IHN0YWNrXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5vcGVuRWxlbWVudHMuc3RhY2tUb3A7IGkgPj0gMDsgaS0tKVxuICAgICAgICAgICAgICAgIG14bi5fc2V0RW5kTG9jYXRpb24odGhpcy5vcGVuRWxlbWVudHMuaXRlbXNbaV0sIG14bi5jdXJyZW50VG9rZW4pO1xuICAgICAgICB9LFxuXG5cbiAgICAgICAgLy9Ub2tlbiBwcm9jZXNzaW5nXG4gICAgICAgIF9wcm9jZXNzVG9rZW5JbkZvcmVpZ25Db250ZW50OiBmdW5jdGlvbiAodG9rZW4pIHtcbiAgICAgICAgICAgIG14bi5jdXJyZW50VG9rZW4gPSB0b2tlbjtcbiAgICAgICAgICAgIG9yaWcuX3Byb2Nlc3NUb2tlbkluRm9yZWlnbkNvbnRlbnQuY2FsbCh0aGlzLCB0b2tlbik7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX3Byb2Nlc3NUb2tlbjogZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgICAgICAgICBteG4uY3VycmVudFRva2VuID0gdG9rZW47XG4gICAgICAgICAgICBvcmlnLl9wcm9jZXNzVG9rZW4uY2FsbCh0aGlzLCB0b2tlbik7XG5cbiAgICAgICAgICAgIC8vTk9URTogPGJvZHk+IGFuZCA8aHRtbD4gYXJlIG5ldmVyIHBvcHBlZCBmcm9tIHRoZSBzdGFjaywgc28gd2UgbmVlZCB0byB1cGRhdGVkXG4gICAgICAgICAgICAvL3RoZWlyIGVuZCBsb2NhdGlvbiBleHBsaWNpdGx5LlxuICAgICAgICAgICAgdmFyIHJlcXVpcmVFeHBsaWNpdFVwZGF0ZSA9IHRva2VuLnR5cGUgPT09IFRva2VuaXplci5FTkRfVEFHX1RPS0VOICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRva2VuLnRhZ05hbWUgPT09ICQuSFRNTCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbi50YWdOYW1lID09PSAkLkJPRFkgJiYgdGhpcy5vcGVuRWxlbWVudHMuaGFzSW5TY29wZSgkLkJPRFkpKTtcblxuICAgICAgICAgICAgaWYgKHJlcXVpcmVFeHBsaWNpdFVwZGF0ZSkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLm9wZW5FbGVtZW50cy5zdGFja1RvcDsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLm9wZW5FbGVtZW50cy5pdGVtc1tpXTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50cmVlQWRhcHRlci5nZXRUYWdOYW1lKGVsZW1lbnQpID09PSB0b2tlbi50YWdOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBteG4uX3NldEVuZExvY2F0aW9uKGVsZW1lbnQsIHRva2VuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuXG5cbiAgICAgICAgLy9Eb2N0eXBlXG4gICAgICAgIF9zZXREb2N1bWVudFR5cGU6IGZ1bmN0aW9uICh0b2tlbikge1xuICAgICAgICAgICAgb3JpZy5fc2V0RG9jdW1lbnRUeXBlLmNhbGwodGhpcywgdG9rZW4pO1xuXG4gICAgICAgICAgICB2YXIgZG9jdW1lbnRDaGlsZHJlbiA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0Q2hpbGROb2Rlcyh0aGlzLmRvY3VtZW50KSxcbiAgICAgICAgICAgICAgICBjbkxlbmd0aCA9IGRvY3VtZW50Q2hpbGRyZW4ubGVuZ3RoO1xuXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNuTGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IGRvY3VtZW50Q2hpbGRyZW5baV07XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmVlQWRhcHRlci5pc0RvY3VtZW50VHlwZU5vZGUobm9kZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5fX2xvY2F0aW9uID0gdG9rZW4ubG9jYXRpb247XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuXG4gICAgICAgIC8vRWxlbWVudHNcbiAgICAgICAgX2F0dGFjaEVsZW1lbnRUb1RyZWU6IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgICAgICAgICAvL05PVEU6IF9hdHRhY2hFbGVtZW50VG9UcmVlIGlzIGNhbGxlZCBmcm9tIF9hcHBlbmRFbGVtZW50LCBfaW5zZXJ0RWxlbWVudCBhbmQgX2luc2VydFRlbXBsYXRlIG1ldGhvZHMuXG4gICAgICAgICAgICAvL1NvIHdlIHdpbGwgdXNlIHRva2VuIGxvY2F0aW9uIHN0b3JlZCBpbiB0aGlzIG1ldGhvZHMgZm9yIHRoZSBlbGVtZW50LlxuICAgICAgICAgICAgbXhuLl9zZXRTdGFydExvY2F0aW9uKGVsZW1lbnQpO1xuICAgICAgICAgICAgbXhuLmxhc3RTdGFydFRhZ1Rva2VuID0gbnVsbDtcbiAgICAgICAgICAgIG9yaWcuX2F0dGFjaEVsZW1lbnRUb1RyZWUuY2FsbCh0aGlzLCBlbGVtZW50KTtcbiAgICAgICAgfSxcblxuICAgICAgICBfYXBwZW5kRWxlbWVudDogZnVuY3Rpb24gKHRva2VuLCBuYW1lc3BhY2VVUkkpIHtcbiAgICAgICAgICAgIG14bi5sYXN0U3RhcnRUYWdUb2tlbiA9IHRva2VuO1xuICAgICAgICAgICAgb3JpZy5fYXBwZW5kRWxlbWVudC5jYWxsKHRoaXMsIHRva2VuLCBuYW1lc3BhY2VVUkkpO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9pbnNlcnRFbGVtZW50OiBmdW5jdGlvbiAodG9rZW4sIG5hbWVzcGFjZVVSSSkge1xuICAgICAgICAgICAgbXhuLmxhc3RTdGFydFRhZ1Rva2VuID0gdG9rZW47XG4gICAgICAgICAgICBvcmlnLl9pbnNlcnRFbGVtZW50LmNhbGwodGhpcywgdG9rZW4sIG5hbWVzcGFjZVVSSSk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgX2luc2VydFRlbXBsYXRlOiBmdW5jdGlvbiAodG9rZW4pIHtcbiAgICAgICAgICAgIG14bi5sYXN0U3RhcnRUYWdUb2tlbiA9IHRva2VuO1xuICAgICAgICAgICAgb3JpZy5faW5zZXJ0VGVtcGxhdGUuY2FsbCh0aGlzLCB0b2tlbik7XG5cbiAgICAgICAgICAgIHZhciB0bXBsQ29udGVudCA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0VGVtcGxhdGVDb250ZW50KHRoaXMub3BlbkVsZW1lbnRzLmN1cnJlbnQpO1xuXG4gICAgICAgICAgICB0bXBsQ29udGVudC5fX2xvY2F0aW9uID0gbnVsbDtcbiAgICAgICAgfSxcblxuICAgICAgICBfaW5zZXJ0RmFrZVJvb3RFbGVtZW50OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBvcmlnLl9pbnNlcnRGYWtlUm9vdEVsZW1lbnQuY2FsbCh0aGlzKTtcbiAgICAgICAgICAgIHRoaXMub3BlbkVsZW1lbnRzLmN1cnJlbnQuX19sb2NhdGlvbiA9IG51bGw7XG4gICAgICAgIH0sXG5cbiAgICAgICAgLy9Db21tZW50c1xuICAgICAgICBfYXBwZW5kQ29tbWVudE5vZGU6IGZ1bmN0aW9uICh0b2tlbiwgcGFyZW50KSB7XG4gICAgICAgICAgICBvcmlnLl9hcHBlbmRDb21tZW50Tm9kZS5jYWxsKHRoaXMsIHRva2VuLCBwYXJlbnQpO1xuXG4gICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLnRyZWVBZGFwdGVyLmdldENoaWxkTm9kZXMocGFyZW50KSxcbiAgICAgICAgICAgICAgICBjb21tZW50Tm9kZSA9IGNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aCAtIDFdO1xuXG4gICAgICAgICAgICBjb21tZW50Tm9kZS5fX2xvY2F0aW9uID0gdG9rZW4ubG9jYXRpb247XG4gICAgICAgIH0sXG5cbiAgICAgICAgLy9UZXh0XG4gICAgICAgIF9maW5kRm9zdGVyUGFyZW50aW5nTG9jYXRpb246IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vTk9URTogc3RvcmUgbGFzdCBmb3N0ZXIgcGFyZW50aW5nIGxvY2F0aW9uLCBzbyB3ZSB3aWxsIGJlIGFibGUgdG8gZmluZCBpbnNlcnRlZCB0ZXh0XG4gICAgICAgICAgICAvL2luIGNhc2Ugb2YgZm9zdGVyIHBhcmVudGluZ1xuICAgICAgICAgICAgbXhuLmxhc3RGb3N0ZXJQYXJlbnRpbmdMb2NhdGlvbiA9IG9yaWcuX2ZpbmRGb3N0ZXJQYXJlbnRpbmdMb2NhdGlvbi5jYWxsKHRoaXMpO1xuXG4gICAgICAgICAgICByZXR1cm4gbXhuLmxhc3RGb3N0ZXJQYXJlbnRpbmdMb2NhdGlvbjtcbiAgICAgICAgfSxcblxuICAgICAgICBfaW5zZXJ0Q2hhcmFjdGVyczogZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgICAgICAgICBvcmlnLl9pbnNlcnRDaGFyYWN0ZXJzLmNhbGwodGhpcywgdG9rZW4pO1xuXG4gICAgICAgICAgICB2YXIgaGFzRm9zdGVyUGFyZW50ID0gdGhpcy5fc2hvdWxkRm9zdGVyUGFyZW50T25JbnNlcnRpb24oKSxcbiAgICAgICAgICAgICAgICBwYXJlbnQgPSBoYXNGb3N0ZXJQYXJlbnQgJiYgbXhuLmxhc3RGb3N0ZXJQYXJlbnRpbmdMb2NhdGlvbi5wYXJlbnQgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5FbGVtZW50cy5jdXJyZW50VG1wbENvbnRlbnQgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5FbGVtZW50cy5jdXJyZW50LFxuICAgICAgICAgICAgICAgIHNpYmxpbmdzID0gdGhpcy50cmVlQWRhcHRlci5nZXRDaGlsZE5vZGVzKHBhcmVudCksXG4gICAgICAgICAgICAgICAgdGV4dE5vZGVJZHggPSBoYXNGb3N0ZXJQYXJlbnQgJiYgbXhuLmxhc3RGb3N0ZXJQYXJlbnRpbmdMb2NhdGlvbi5iZWZvcmVFbGVtZW50ID9cbiAgICAgICAgICAgICAgICBzaWJsaW5ncy5pbmRleE9mKG14bi5sYXN0Rm9zdGVyUGFyZW50aW5nTG9jYXRpb24uYmVmb3JlRWxlbWVudCkgLSAxIDpcbiAgICAgICAgICAgICAgICBzaWJsaW5ncy5sZW5ndGggLSAxLFxuICAgICAgICAgICAgICAgIHRleHROb2RlID0gc2libGluZ3NbdGV4dE5vZGVJZHhdO1xuXG4gICAgICAgICAgICAvL05PVEU6IGlmIHdlIGhhdmUgbG9jYXRpb24gYXNzaWduZWQgYnkgYW5vdGhlciB0b2tlbiwgdGhlbiBqdXN0IHVwZGF0ZSBlbmQgcG9zaXRpb25cbiAgICAgICAgICAgIGlmICh0ZXh0Tm9kZS5fX2xvY2F0aW9uKVxuICAgICAgICAgICAgICAgIHRleHROb2RlLl9fbG9jYXRpb24uZW5kT2Zmc2V0ID0gdG9rZW4ubG9jYXRpb24uZW5kT2Zmc2V0O1xuXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgdGV4dE5vZGUuX19sb2NhdGlvbiA9IHRva2VuLmxvY2F0aW9uO1xuICAgICAgICB9XG4gICAgfTtcbn07XG5cbiJdfQ==