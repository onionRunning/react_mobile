2f72ac831106181f4d944c9ac0f9ccda
/*
	compiles a selector to an executable function
*/
module.exports = compile;
module.exports.compileUnsafe = compileUnsafe;
module.exports.compileToken = compileToken;

var parse = require("css-what"),
    DomUtils = require("domutils"),
    isTag = DomUtils.isTag,
    Rules = require("./general.js"),
    sortRules = require("./sort.js"),
    BaseFuncs = require("boolbase"),
    trueFunc = BaseFuncs.trueFunc,
    falseFunc = BaseFuncs.falseFunc,
    procedure = require("./procedure.json");

function compile(selector, options, context) {
  var next = compileUnsafe(selector, options, context);
  return wrap(next);
}

function wrap(next) {
  return function base(elem) {
    return isTag(elem) && next(elem);
  };
}

function compileUnsafe(selector, options, context) {
  var token = parse(selector, options);
  return compileToken(token, options, context);
}

function includesScopePseudo(t) {
  return t.type === "pseudo" && (t.name === "scope" || Array.isArray(t.data) && t.data.some(function (data) {
    return data.some(includesScopePseudo);
  }));
}

var DESCENDANT_TOKEN = {
  type: "descendant"
},
    SCOPE_TOKEN = {
  type: "pseudo",
  name: "scope"
},
    PLACEHOLDER_ELEMENT = {},
    getParent = DomUtils.getParent; //CSS 4 Spec (Draft): 3.3.1. Absolutizing a Scope-relative Selector
//http://www.w3.org/TR/selectors4/#absolutizing

function absolutize(token, context) {
  //TODO better check if context is document
  var hasContext = !!context && !!context.length && context.every(function (e) {
    return e === PLACEHOLDER_ELEMENT || !!getParent(e);
  });
  token.forEach(function (t) {
    if (t.length > 0 && isTraversal(t[0]) && t[0].type !== "descendant") {//don't return in else branch
    } else if (hasContext && !includesScopePseudo(t)) {
      t.unshift(DESCENDANT_TOKEN);
    } else {
      return;
    }

    t.unshift(SCOPE_TOKEN);
  });
}

function compileToken(token, options, context) {
  token = token.filter(function (t) {
    return t.length > 0;
  });
  token.forEach(sortRules);
  var isArrayContext = Array.isArray(context);
  context = options && options.context || context;
  if (context && !isArrayContext) context = [context];
  absolutize(token, context);
  return token.map(function (rules) {
    return compileRules(rules, options, context, isArrayContext);
  }).reduce(reduceRules, falseFunc);
}

function isTraversal(t) {
  return procedure[t.type] < 0;
}

function compileRules(rules, options, context, isArrayContext) {
  var acceptSelf = isArrayContext && rules[0].name === "scope" && rules[1].type === "descendant";
  return rules.reduce(function (func, rule, index) {
    if (func === falseFunc) return func;
    return Rules[rule.type](func, rule, options, context, acceptSelf && index === 1);
  }, options && options.rootFunc || trueFunc);
}

function reduceRules(a, b) {
  if (b === falseFunc || a === trueFunc) {
    return a;
  }

  if (a === falseFunc || b === trueFunc) {
    return b;
  }

  return function combine(elem) {
    return a(elem) || b(elem);
  };
} //:not, :has and :matches have to compile selectors
//doing this in lib/pseudos.js would lead to circular dependencies,
//so we add them here


var Pseudos = require("./pseudos.js"),
    filters = Pseudos.filters,
    existsOne = DomUtils.existsOne,
    isTag = DomUtils.isTag,
    getChildren = DomUtils.getChildren;

function containsTraversal(t) {
  return t.some(isTraversal);
}

filters.not = function (next, token, options, context) {
  var opts = {
    xmlMode: !!(options && options.xmlMode),
    strict: !!(options && options.strict)
  };

  if (opts.strict) {
    if (token.length > 1 || token.some(containsTraversal)) {
      throw new SyntaxError("complex selectors in :not aren't allowed in strict mode");
    }
  }

  var func = compileToken(token, opts, context);
  if (func === falseFunc) return next;
  if (func === trueFunc) return falseFunc;
  return function (elem) {
    return !func(elem) && next(elem);
  };
};

filters.has = function (next, token, options) {
  var opts = {
    xmlMode: !!(options && options.xmlMode),
    strict: !!(options && options.strict)
  }; //FIXME: Uses an array as a pointer to the current element (side effects)

  var context = token.some(containsTraversal) ? [PLACEHOLDER_ELEMENT] : null;
  var func = compileToken(token, opts, context);
  if (func === falseFunc) return falseFunc;
  if (func === trueFunc) return function (elem) {
    return getChildren(elem).some(isTag) && next(elem);
  };
  func = wrap(func);

  if (context) {
    return function has(elem) {
      return next(elem) && (context[0] = elem, existsOne(func, getChildren(elem)));
    };
  }

  return function has(elem) {
    return next(elem) && existsOne(func, getChildren(elem));
  };
};

filters.matches = function (next, token, options, context) {
  var opts = {
    xmlMode: !!(options && options.xmlMode),
    strict: !!(options && options.strict),
    rootFunc: next
  };
  return compileToken(token, opts, context);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBpbGUuanMiXSwibmFtZXMiOlsibW9kdWxlIiwiZXhwb3J0cyIsImNvbXBpbGUiLCJjb21waWxlVW5zYWZlIiwiY29tcGlsZVRva2VuIiwicGFyc2UiLCJyZXF1aXJlIiwiRG9tVXRpbHMiLCJpc1RhZyIsIlJ1bGVzIiwic29ydFJ1bGVzIiwiQmFzZUZ1bmNzIiwidHJ1ZUZ1bmMiLCJmYWxzZUZ1bmMiLCJwcm9jZWR1cmUiLCJzZWxlY3RvciIsIm9wdGlvbnMiLCJjb250ZXh0IiwibmV4dCIsIndyYXAiLCJiYXNlIiwiZWxlbSIsInRva2VuIiwiaW5jbHVkZXNTY29wZVBzZXVkbyIsInQiLCJ0eXBlIiwibmFtZSIsIkFycmF5IiwiaXNBcnJheSIsImRhdGEiLCJzb21lIiwiREVTQ0VOREFOVF9UT0tFTiIsIlNDT1BFX1RPS0VOIiwiUExBQ0VIT0xERVJfRUxFTUVOVCIsImdldFBhcmVudCIsImFic29sdXRpemUiLCJoYXNDb250ZXh0IiwibGVuZ3RoIiwiZXZlcnkiLCJlIiwiZm9yRWFjaCIsImlzVHJhdmVyc2FsIiwidW5zaGlmdCIsImZpbHRlciIsImlzQXJyYXlDb250ZXh0IiwibWFwIiwicnVsZXMiLCJjb21waWxlUnVsZXMiLCJyZWR1Y2UiLCJyZWR1Y2VSdWxlcyIsImFjY2VwdFNlbGYiLCJmdW5jIiwicnVsZSIsImluZGV4Iiwicm9vdEZ1bmMiLCJhIiwiYiIsImNvbWJpbmUiLCJQc2V1ZG9zIiwiZmlsdGVycyIsImV4aXN0c09uZSIsImdldENoaWxkcmVuIiwiY29udGFpbnNUcmF2ZXJzYWwiLCJub3QiLCJvcHRzIiwieG1sTW9kZSIsInN0cmljdCIsIlN5bnRheEVycm9yIiwiaGFzIiwibWF0Y2hlcyJdLCJtYXBwaW5ncyI6IkFBQUE7OztBQUlBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUJDLE9BQWpCO0FBQ0FGLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlRSxhQUFmLEdBQStCQSxhQUEvQjtBQUNBSCxNQUFNLENBQUNDLE9BQVAsQ0FBZUcsWUFB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SSxDQUFDRyxJQUFELENBQUosS0FDUUosT0FBTyxDQUFDLENBQUQsQ0FBUCxHQUFhSSxJQUFkLEVBQXFCdUMsU0FBUyxDQUFDVCxJQUFELEVBQU9VLFdBQVcsQ0FBQ3hDLElBQUQsQ0FBbEIsQ0FEckMsQ0FBUDtBQUdBLEtBSk07QUFLSDs7QUFFRCxTQUFPLFNBQVMrQyxHQUFULENBQWEvQyxJQUFiLEVBQWtCO0FBQzNCLFdBQU9ILElBQUksQ0FBQ0csSUFBRCxDQUFKLElBQWN1QyxTQUFTLENBQUNULElBQUQsRUFBT1UsV0FBVyxDQUFDeEMsSUFBRCxDQUFsQixDQUE5QjtBQUNBLEdBRkU7QUFHSCxDQTdCRDs7QUErQkFzQyxPQUFPLENBQUNVLE9BQVIsR0FBa0IsVUFBU25ELElBQVQsRUFBZUksS0FBZixFQUFzQk4sT0FBdEIsRUFBK0JDLE9BQS9CLEVBQXVDO0FBQ3hELE1BQUkrQyxJQUFJLEdBQUc7QUFDVkMsSUFBQUEsT0FBTyxFQUFFLENBQUMsRUFBRWpELE9BQU8sSUFBSUEsT0FBTyxDQUFDaUQsT0FBckIsQ0FEQTtBQUVWQyxJQUFBQSxNQUFNLEVBQUUsQ0FBQyxFQUFFbEQsT0FBTyxJQUFJQSxPQUFPLENBQUNrRCxNQUFyQixDQUZDO0FBR1ZaLElBQUFBLFFBQVEsRUFBRXBDO0FBSEEsR0FBWDtBQU1BLFNBQU9kLFlBQVksQ0FBQ2tCLEtBQUQsRUFBUTBDLElBQVIsRUFBYy9DLE9BQWQsQ0FBbkI7QUFDQSxDQVJEIiwic291cmNlc0NvbnRlbnQiOlsiLypcblx0Y29tcGlsZXMgYSBzZWxlY3RvciB0byBhbiBleGVjdXRhYmxlIGZ1bmN0aW9uXG4qL1xuXG5tb2R1bGUuZXhwb3J0cyA9IGNvbXBpbGU7XG5tb2R1bGUuZXhwb3J0cy5jb21waWxlVW5zYWZlID0gY29tcGlsZVVuc2FmZTtcbm1vZHVsZS5leHBvcnRzLmNvbXBpbGVUb2tlbiA9IGNvbXBpbGVUb2tlbjtcblxudmFyIHBhcnNlICAgICAgID0gcmVxdWlyZShcImNzcy13aGF0XCIpLFxuICAgIERvbVV0aWxzICAgID0gcmVxdWlyZShcImRvbXV0aWxzXCIpLFxuICAgIGlzVGFnICAgICAgID0gRG9tVXRpbHMuaXNUYWcsXG4gICAgUnVsZXMgICAgICAgPSByZXF1aXJlKFwiLi9nZW5lcmFsLmpzXCIpLFxuICAgIHNvcnRSdWxlcyAgID0gcmVxdWlyZShcIi4vc29ydC5qc1wiKSxcbiAgICBCYXNlRnVuY3MgICA9IHJlcXVpcmUoXCJib29sYmFzZVwiKSxcbiAgICB0cnVlRnVuYyAgICA9IEJhc2VGdW5jcy50cnVlRnVuYyxcbiAgICBmYWxzZUZ1bmMgICA9IEJhc2VGdW5jcy5mYWxzZUZ1bmMsXG4gICAgcHJvY2VkdXJlICAgPSByZXF1aXJlKFwiLi9wcm9jZWR1cmUuanNvblwiKTtcblxuZnVuY3Rpb24gY29tcGlsZShzZWxlY3Rvciwgb3B0aW9ucywgY29udGV4dCl7XG5cdHZhciBuZXh0ID0gY29tcGlsZVVuc2FmZShzZWxlY3Rvciwgb3B0aW9ucywgY29udGV4dCk7XG5cdHJldHVybiB3cmFwKG5leHQpO1xufVxuXG5mdW5jdGlvbiB3cmFwKG5leHQpe1xuXHRyZXR1cm4gZnVuY3Rpb24gYmFzZShlbGVtKXtcblx0XHRyZXR1cm4gaXNUYWcoZWxlbSkgJiYgbmV4dChlbGVtKTtcblx0fTtcbn1cblxuZnVuY3Rpb24gY29tcGlsZVVuc2FmZShzZWxlY3Rvciwgb3B0aW9ucywgY29udGV4dCl7XG5cdHZhciB0b2tlbiA9IHBhcnNlKHNlbGVjdG9yLCBvcHRpb25zKTtcblx0cmV0dXJuIGNvbXBpbGVUb2tlbih0b2tlbiwgb3B0aW9ucywgY29udGV4dCk7XG59XG5cbmZ1bmN0aW9uIGluY2x1ZGVzU2NvcGVQc2V1ZG8odCl7XG4gICAgcmV0dXJuIHQudHlwZSA9PT0gXCJwc2V1ZG9cIiAmJiAoXG4gICAgICAgIHQubmFtZSA9PT0gXCJzY29wZVwiIHx8IChcbiAgICAgICAgICAgIEFycmF5LmlzQXJyYXkodC5kYXRhKSAmJlxuICAgICAgICAgICAgdC5kYXRhLnNvbWUoZnVuY3Rpb24oZGF0YSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGEuc29tZShpbmNsdWRlc1Njb3BlUHNldWRvKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICApO1xufVxuXG52YXIgREVTQ0VOREFOVF9UT0tFTiA9IHt0eXBlOiBcImRlc2NlbmRhbnRcIn0sXG4gICAgU0NPUEVfVE9LRU4gPSB7dHlwZTogXCJwc2V1ZG9cIiwgbmFtZTogXCJzY29wZVwifSxcbiAgICBQTEFDRUhPTERFUl9FTEVNRU5UID0ge30sXG4gICAgZ2V0UGFyZW50ID0gRG9tVXRpbHMuZ2V0UGFyZW50O1xuXG4vL0NTUyA0IFNwZWMgKERyYWZ0KTogMy4zLjEuIEFic29sdXRpemluZyBhIFNjb3BlLXJlbGF0aXZlIFNlbGVjdG9yXG4vL2h0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9yczQvI2Fic29sdXRpemluZ1xuZnVuY3Rpb24gYWJzb2x1dGl6ZSh0b2tlbiwgY29udGV4dCl7XG4gICAgLy9UT0RPIGJldHRlciBjaGVjayBpZiBjb250ZXh0IGlzIGRvY3VtZW50XG4gICAgdmFyIGhhc0NvbnRleHQgPSAhIWNvbnRleHQgJiYgISFjb250ZXh0Lmxlbmd0aCAmJiBjb250ZXh0LmV2ZXJ5KGZ1bmN0aW9uKGUpe1xuICAgICAgICByZXR1cm4gZSA9PT0gUExBQ0VIT0xERVJfRUxFTUVOVCB8fCAhIWdldFBhcmVudChlKTtcbiAgICB9KTtcblxuXG4gICAgdG9rZW4uZm9yRWFjaChmdW5jdGlvbih0KXtcbiAgICAgICAgaWYodC5sZW5ndGggPiAwICYmIGlzVHJhdmVyc2FsKHRbMF0pICYmIHRbMF0udHlwZSAhPT0gXCJkZXNjZW5kYW50XCIpe1xuICAgICAgICAgICAgLy9kb24ndCByZXR1cm4gaW4gZWxzZSBicmFuY2hcbiAgICAgICAgfSBlbHNlIGlmKGhhc0NvbnRleHQgJiYgIWluY2x1ZGVzU2NvcGVQc2V1ZG8odCkpe1xuICAgICAgICAgICAgdC51bnNoaWZ0KERFU0NFTkRBTlRfVE9LRU4pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdC51bnNoaWZ0KFNDT1BFX1RPS0VOKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gY29tcGlsZVRva2VuKHRva2VuLCBvcHRpb25zLCBjb250ZXh0KXtcbiAgICB0b2tlbiA9IHRva2VuLmZpbHRlcihmdW5jdGlvbih0KXsgcmV0dXJuIHQubGVuZ3RoID4gMDsgfSk7XG5cblx0dG9rZW4uZm9yRWFjaChzb3J0UnVsZXMpO1xuXG5cdHZhciBpc0FycmF5Q29udGV4dCA9IEFycmF5LmlzQXJyYXkoY29udGV4dCk7XG5cbiAgICBjb250ZXh0ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5jb250ZXh0KSB8fCBjb250ZXh0O1xuXG4gICAgaWYoY29udGV4dCAmJiAhaXNBcnJheUNvbnRleHQpIGNvbnRleHQgPSBbY29udGV4dF07XG5cbiAgICBhYnNvbHV0aXplKHRva2VuLCBjb250ZXh0KTtcblxuXHRyZXR1cm4gdG9rZW5cblx0XHQubWFwKGZ1bmN0aW9uKHJ1bGVzKXsgcmV0dXJuIGNvbXBpbGVSdWxlcyhydWxlcywgb3B0aW9ucywgY29udGV4dCwgaXNBcnJheUNvbnRleHQpOyB9KVxuXHRcdC5yZWR1Y2UocmVkdWNlUnVsZXMsIGZhbHNlRnVuYyk7XG59XG5cbmZ1bmN0aW9uIGlzVHJhdmVyc2FsKHQpe1xuXHRyZXR1cm4gcHJvY2VkdXJlW3QudHlwZV0gPCAwO1xufVxuXG5mdW5jdGlvbiBjb21waWxlUnVsZXMocnVsZXMsIG9wdGlvbnMsIGNvbnRleHQsIGlzQXJyYXlDb250ZXh0KXtcblx0dmFyIGFjY2VwdFNlbGYgPSAoaXNBcnJheUNvbnRleHQgJiYgcnVsZXNbMF0ubmFtZSA9PT0gXCJzY29wZVwiICYmIHJ1bGVzWzFdLnR5cGUgPT09IFwiZGVzY2VuZGFudFwiKTtcblx0cmV0dXJuIHJ1bGVzLnJlZHVjZShmdW5jdGlvbihmdW5jLCBydWxlLCBpbmRleCl7XG5cdFx0aWYoZnVuYyA9PT0gZmFsc2VGdW5jKSByZXR1cm4gZnVuYztcblx0XHRyZXR1cm4gUnVsZXNbcnVsZS50eXBlXShmdW5jLCBydWxlLCBvcHRpb25zLCBjb250ZXh0LCBhY2NlcHRTZWxmICYmIGluZGV4ID09PSAxKTtcblx0fSwgb3B0aW9ucyAmJiBvcHRpb25zLnJvb3RGdW5jIHx8IHRydWVGdW5jKTtcbn1cblxuZnVuY3Rpb24gcmVkdWNlUnVsZXMoYSwgYil7XG5cdGlmKGIgPT09IGZhbHNlRnVuYyB8fCBhID09PSB0cnVlRnVuYyl7XG5cdFx0cmV0dXJuIGE7XG5cdH1cblx0aWYoYSA9PT0gZmFsc2VGdW5jIHx8IGIgPT09IHRydWVGdW5jKXtcblx0XHRyZXR1cm4gYjtcblx0fVxuXG5cdHJldHVybiBmdW5jdGlvbiBjb21iaW5lKGVsZW0pe1xuXHRcdHJldHVybiBhKGVsZW0pIHx8IGIoZWxlbSk7XG5cdH07XG59XG5cbi8vOm5vdCwgOmhhcyBhbmQgOm1hdGNoZXMgaGF2ZSB0byBjb21waWxlIHNlbGVjdG9yc1xuLy9kb2luZyB0aGlzIGluIGxpYi9wc2V1ZG9zLmpzIHdvdWxkIGxlYWQgdG8gY2lyY3VsYXIgZGVwZW5kZW5jaWVzLFxuLy9zbyB3ZSBhZGQgdGhlbSBoZXJlXG5cbnZhciBQc2V1ZG9zICAgICA9IHJlcXVpcmUoXCIuL3BzZXVkb3MuanNcIiksXG4gICAgZmlsdGVycyAgICAgPSBQc2V1ZG9zLmZpbHRlcnMsXG4gICAgZXhpc3RzT25lICAgPSBEb21VdGlscy5leGlzdHNPbmUsXG4gICAgaXNUYWcgICAgICAgPSBEb21VdGlscy5pc1RhZyxcbiAgICBnZXRDaGlsZHJlbiA9IERvbVV0aWxzLmdldENoaWxkcmVuO1xuXG5cbmZ1bmN0aW9uIGNvbnRhaW5zVHJhdmVyc2FsKHQpe1xuXHRyZXR1cm4gdC5zb21lKGlzVHJhdmVyc2FsKTtcbn1cblxuZmlsdGVycy5ub3QgPSBmdW5jdGlvbihuZXh0LCB0b2tlbiwgb3B0aW9ucywgY29udGV4dCl7XG5cdHZhciBvcHRzID0ge1xuXHQgICAgXHR4bWxNb2RlOiAhIShvcHRpb25zICYmIG9wdGlvbnMueG1sTW9kZSksXG5cdCAgICBcdHN0cmljdDogISEob3B0aW9ucyAmJiBvcHRpb25zLnN0cmljdClcblx0ICAgIH07XG5cblx0aWYob3B0cy5zdHJpY3Qpe1xuXHRcdGlmKHRva2VuLmxlbmd0aCA+IDEgfHwgdG9rZW4uc29tZShjb250YWluc1RyYXZlcnNhbCkpe1xuXHRcdFx0dGhyb3cgbmV3IFN5bnRheEVycm9yKFwiY29tcGxleCBzZWxlY3RvcnMgaW4gOm5vdCBhcmVuJ3QgYWxsb3dlZCBpbiBzdHJpY3QgbW9kZVwiKTtcblx0XHR9XG5cdH1cblxuICAgIHZhciBmdW5jID0gY29tcGlsZVRva2VuKHRva2VuLCBvcHRzLCBjb250ZXh0KTtcblxuXHRpZihmdW5jID09PSBmYWxzZUZ1bmMpIHJldHVybiBuZXh0O1xuXHRpZihmdW5jID09PSB0cnVlRnVuYykgIHJldHVybiBmYWxzZUZ1bmM7XG5cblx0cmV0dXJuIGZ1bmN0aW9uKGVsZW0pe1xuXHRcdHJldHVybiAhZnVuYyhlbGVtKSAmJiBuZXh0KGVsZW0pO1xuXHR9O1xufTtcblxuZmlsdGVycy5oYXMgPSBmdW5jdGlvbihuZXh0LCB0b2tlbiwgb3B0aW9ucyl7XG5cdHZhciBvcHRzID0ge1xuXHRcdHhtbE1vZGU6ICEhKG9wdGlvbnMgJiYgb3B0aW9ucy54bWxNb2RlKSxcblx0XHRzdHJpY3Q6ICEhKG9wdGlvbnMgJiYgb3B0aW9ucy5zdHJpY3QpXG5cdH07XG5cbiAgICAvL0ZJWE1FOiBVc2VzIGFuIGFycmF5IGFzIGEgcG9pbnRlciB0byB0aGUgY3VycmVudCBlbGVtZW50IChzaWRlIGVmZmVjdHMpXG4gICAgdmFyIGNvbnRleHQgPSB0b2tlbi5zb21lKGNvbnRhaW5zVHJhdmVyc2FsKSA/IFtQTEFDRUhPTERFUl9FTEVNRU5UXSA6IG51bGw7XG5cblx0dmFyIGZ1bmMgPSBjb21waWxlVG9rZW4odG9rZW4sIG9wdHMsIGNvbnRleHQpO1xuXG5cdGlmKGZ1bmMgPT09IGZhbHNlRnVuYykgcmV0dXJuIGZhbHNlRnVuYztcblx0aWYoZnVuYyA9PT0gdHJ1ZUZ1bmMpICByZXR1cm4gZnVuY3Rpb24oZWxlbSl7XG5cdFx0XHRyZXR1cm4gZ2V0Q2hpbGRyZW4oZWxlbSkuc29tZShpc1RhZykgJiYgbmV4dChlbGVtKTtcblx0XHR9O1xuXG5cdGZ1bmMgPSB3cmFwKGZ1bmMpO1xuXG4gICAgaWYoY29udGV4dCl7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiBoYXMoZWxlbSl7XG5cdFx0cmV0dXJuIG5leHQoZWxlbSkgJiYgKFxuICAgICAgICAgICAgICAgIChjb250ZXh0WzBdID0gZWxlbSksIGV4aXN0c09uZShmdW5jLCBnZXRDaGlsZHJlbihlbGVtKSlcbiAgICAgICAgICAgICk7XG5cdH07XG4gICAgfVxuXG4gICAgcmV0dXJuIGZ1bmN0aW9uIGhhcyhlbGVtKXtcblx0XHRyZXR1cm4gbmV4dChlbGVtKSAmJiBleGlzdHNPbmUoZnVuYywgZ2V0Q2hpbGRyZW4oZWxlbSkpO1xuXHR9O1xufTtcblxuZmlsdGVycy5tYXRjaGVzID0gZnVuY3Rpb24obmV4dCwgdG9rZW4sIG9wdGlvbnMsIGNvbnRleHQpe1xuXHR2YXIgb3B0cyA9IHtcblx0XHR4bWxNb2RlOiAhIShvcHRpb25zICYmIG9wdGlvbnMueG1sTW9kZSksXG5cdFx0c3RyaWN0OiAhIShvcHRpb25zICYmIG9wdGlvbnMuc3RyaWN0KSxcblx0XHRyb290RnVuYzogbmV4dFxuXHR9O1xuXG5cdHJldHVybiBjb21waWxlVG9rZW4odG9rZW4sIG9wdHMsIGNvbnRleHQpO1xufTtcbiJdfQ==