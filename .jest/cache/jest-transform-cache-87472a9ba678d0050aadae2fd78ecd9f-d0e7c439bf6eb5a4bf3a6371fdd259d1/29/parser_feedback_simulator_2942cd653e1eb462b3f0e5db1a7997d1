9aa748f51ac2c4fdbca654d0ca6f78a8
'use strict';

var Tokenizer = require('../tokenizer'),
    foreignContent = require('../common/foreign_content'),
    UNICODE = require('../common/unicode'),
    HTML = require('../common/html'); //Aliases


var $ = HTML.TAG_NAMES,
    NS = HTML.NAMESPACES; //ParserFeedbackSimulator
//Simulates adjustment of the Tokenizer which performed by standard parser during tree construction.

var ParserFeedbackSimulator = module.exports = function (tokenizer) {
  this.tokenizer = tokenizer;
  this.namespaceStack = [];
  this.namespaceStackTop = -1;

  this._enterNamespace(NS.HTML);
};

ParserFeedbackSimulator.prototype.getNextToken = function () {
  var token = this.tokenizer.getNextToken();
  if (token.type === Tokenizer.START_TAG_TOKEN) this._handleStartTagToken(token);else if (token.type === Tokenizer.END_TAG_TOKEN) this._handleEndTagToken(token);else if (token.type === Tokenizer.NULL_CHARACTER_TOKEN && this.inForeignContent) {
    token.type = Tokenizer.CHARACTER_TOKEN;
    token.chars = UNICODE.REPLACEMENT_CHARACTER;
  } else if (this.skipNextNewLine) {
    if (token.type !== Tokenizer.HIBERNATION_TOKEN) this.skipNextNewLine = false;

    if (token.type === Tokenizer.WHITESPACE_CHARACTER_TOKEN && token.chars[0] === '\n') {
      if (token.chars.length === 1) return this.getNextToken();
      token.chars = token.chars.substr(1);
    }
  }
  return token;
}; //Namespace stack mutations


ParserFeedbackSimulator.prototype._enterNamespace = function (namespace) {
  this.namespaceStackTop++;
  this.namespaceStack.push(namespace);
  this.inForeignContent = namespace !== NS.HTML;
  this.currentNamespace = namespace;
  this.tokenizer.allowCDATA = this.inForeignContent;
};

ParserFeedbackSimulator.prototype._leaveCurrentNamespace = function () {
  this.namespaceStackTop--;
  this.namespaceStack.pop();
  this.currentNamespace = this.namespaceStack[this.namespaceStackTop];
  this.inForeignContent = this.currentNamespace !== NS.HTML;
  this.tokenizer.allowCDATA = this.inForeignContent;
}; //Token handlers


ParserFeedbackSimulator.prototype._ensureTokenizerMode = function (tn) {
  if (tn === $.TEXTAREA || tn === $.TITLE) this.tokenizer.state = Tokenizer.MODE.RCDATA;else if (tn === $.PLAINTEXT) this.tokenizer.state = Tokenizer.MODE.PLAINTEXT;else if (tn === $.SCRIPT) this.tokenizer.state = Tokenizer.MODE.SCRIPT_DATA;else if (tn === $.STYLE || tn === $.IFRAME || tn === $.XMP || tn === $.NOEMBED || tn === $.NOFRAMES || tn === $.NOSCRIPT) this.tokenizer.state = Tokenizer.MODE.RAWTEXT;
};

ParserFeedbackSimulator.prototype._handleStartTagToken = function (token) {
  var tn = token.tagName;
  if (tn === $.SVG) this._enterNamespace(NS.SVG);else if (tn === $.MATH) this._enterNamespace(NS.MATHML);

  if (this.inForeignContent) {
    if (foreignContent.causesExit(token)) {
      this._leaveCurrentNamespace();

      return;
    }

    var currentNs = this.currentNamespace;
    if (currentNs === NS.MATHML) foreignContent.adjustTokenMathMLAttrs(token);else if (currentNs === NS.SVG) {
      foreignContent.adjustTokenSVGTagName(token);
      foreignContent.adjustTokenSVGAttrs(token);
    }
    foreignContent.adjustTokenXMLAttrs(token);
    tn = token.tagName;
    if (!token.selfClosing && foreignContent.isIntegrationPoint(tn, currentNs, token.attrs)) this._enterNamespace(NS.HTML);
  } else {
    if (tn === $.PRE || tn === $.TEXTAREA || tn === $.LISTING) this.skipNextNewLine = true;else if (tn === $.IMAGE) token.tagName = $.IMG;

    this._ensureTokenizerMode(tn);
  }
};

ParserFeedbackSimulator.prototype._handleEndTagToken = function (token) {
  var tn = token.tagName;

  if (!this.inForeignContent) {
    var previousNs = this.namespaceStack[this.namespaceStackTop - 1];
    if (previousNs === NS.SVG && foreignContent.SVG_TAG_NAMES_ADJUSTMENT_MAP[tn]) tn = foreignContent.SVG_TAG_NAMES_ADJUSTMENT_MAP[tn]; //NOTE: check for exit from integration point

    if (foreignContent.isIntegrationPoint(tn, previousNs, token.attrs)) this._leaveCurrentNamespace();
  } else if (tn === $.SVG && this.currentNamespace === NS.SVG || tn === $.MATH && this.currentNamespace === NS.MATHML) this._leaveCurrentNamespace(); // NOTE: adjust end tag name as well for consistency


  if (this.currentNamespace === NS.SVG) foreignContent.adjustTokenSVGTagName(token);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlcl9mZWVkYmFja19zaW11bGF0b3IuanMiXSwibmFtZXMiOlsiVG9rZW5pemVyIiwicmVxdWlyZSIsImZvcmVpZ25Db250ZW50IiwiVU5JQ09ERSIsIkhUTUwiLCIkIiwiVEFHX05BTUVTIiwiTlMiLCJOQU1FU1BBQ0VTIiwiUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IiLCJtb2R1bGUiLCJleHBvcnRzIiwidG9rZW5pemVyIiwibmFtZXNwYWNlU3RhY2siLCJuYW1lc3BhY2VTdGFja1RvcCIsIl9lbnRlck5hbWVzcGFjZSIsInByb3RvdHlwZSIsImdldE5leHRUb2tlbiIsInRva2VuIiwidHlwZSIsIlNUQVJUX1RBR19UT0tFTiIsIl9oYW5kbGVTdGFydFRhZ1Rva2VuIiwiRU5EX1RBR19UT0tFTiIsIl9oYW5kbGVFbmRUYWdUb2tlbiIsIk5VTExfQ0hBUkFDVEVSX1RPS0VOIiwiaW5Gb3JlaWduQ29udGVudCIsIkNIQVJBQ1RFUl9UT0tFTiIsImNoYXJzIiwiUkVQTEFDRU1FTlRfQ0hBUkFDVEVSIiwic2tpcE5leHROZXdMaW5lIiwiSElCRVJOQVRJT05fVE9LRU4iLCJXSElURVNQQUNFX0NIQVJBQ1RFUl9UT0tFTiIsImxlbmd0aCIsInN1YnN0ciIsIm5hbWVzcGFjZSIsInB1c2giLCJjdXJyZW50TmFtZXNwYWNlIiwiYWxsb3dDREFUQSIsIl9sZWF2ZUN1cnJlbnROYW1lc3BhY2UiLCJwb3AiLCJfZW5zdXJlVG9rZW5pemVyTW9kZSIsInRuIiwiVEVYVEFSRUEiLCJUSVRMRSIsInN0YXRlIiwiTU9ERSIsIlJDREFUQSIsIlBMQUlOVEVYVCIsIlNDUklQVCIsIlNDUklQVF9EQVRBIiwiU1RZTEUiLCJJRlJBTUUiLCJYTVAiLCJOT0VNQkVEIiwiTk9GUkFNRVMiLCJOT1NDUklQVCIsIlJBV1RFWFQiLCJ0YWdOYW1lIiwiU1ZHIiwiTUFUSCIsIk1BVEhNTCIsImNhdXNlc0V4aXQiLCJjdXJyZW50TnMiLCJhZGp1c3RUb2tlbk1hdGhNTEF0dHJzIiwiYWRqdXN0VG9rZW5TVkdUYWdOYW1lIiwiYWRqdXN0VG9rZW5TVkdBdHRycyIsImFkanVzdFRva2VuWE1MQXR0cnMiLCJzZWxmQ2xvc2luZyIsImlzSW50ZWdyYXRpb25Qb2ludCIsImF0dHJzIiwiUFJFIiwiTElTVElORyIsIklNQUdFIiwiSU1HIiwicHJldmlvdXNOcyIsIlNWR19UQUdfTkFNRVNfQURKVVNUTUVOVF9NQVAiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLFNBQVMsR0FBR0MsT0FBTyxDQUFDLGNBQUQsQ0FBdkI7QUFBQSxJQUNJQyxjQUFjLEdBQUdELE9BQU8sQ0FBQywyQkFBRCxDQUQ1QjtBQUFBLElBRUlFLE9BQU8sR0FBR0YsT0FBTyxDQUFDLG1CQUFELENBRnJCO0FBQUEsSUFHSUcsSUFBSSxHQUFHSCxPQUFPLENBQUMsZ0JBQUQsQ0FIbEIsQyxDQU1BOzs7QUFDQSxJQUFJSSxDQUFDLEdBQUdELElBQUksQ0FBQ0UsU0FBYjtBQUFBLElBQ0lDLEVBQUUsR0FBR0gsSUFBSSxDQUFDSSxVQURkLEMsQ0FJQTtBQUNBOztBQUNBLElBQUlDLHVCQUF1QixHQUFHQyxNQUFNLENBQUNDLE9BQVAsR0FBaUIsVUFBVUMsU0FBVixFQUFxQjtBQUNoRSxPQUFLQSxTQUFMLEdBQWlCQSxTQUFqQjtBQUVBLE9BQUtDLGNBQUwsR0FBc0IsRUFBdEI7QUFDQSxPQUFLQyxpQkFBTCxHQUF5QixDQUFDLENBQTFCOztBQUNBLE9BQUtDLGVBQUwsQ0FBcUJSLEVBQUUsQ0FBQ0gsSUFBeEI7QUFDSCxDQU5EOztBQVFBSyx1QkFBdUIsQ0FBQ08sU0FBeEIsQ0FBa0NDLFlBQWxDLEdBQWlELFlBQVk7QUFDekQsTUFBSUMsS0FBSyxHQUFHLEtBQUtOLFNBQUwsQ0FBZUssWUFBZixFQUFaO0FBRUEsTUFBSUMsS0FBSyxDQUFDQyxJQUFOLEtBQWVuQixTQUFTLENBQUNvQixlQUE3QixFQUNJLEtBQUtDLG9CQUFMLENBQTBCSCxLQUExQixFQURKLEtBR0ssSUFBSUEsS0FBSyxDQUFDQyxJQUFOLEtBQWVu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LEtBQUssQ0FBQ21ELEtBQXhELENBQUosRUFDSSxLQUFLL0Isc0JBQUw7QUFDUCxHQVRELE1BV0ssSUFBSUcsRUFBRSxLQUFLcEMsQ0FBQyxDQUFDcUQsR0FBVCxJQUFnQixLQUFLdEIsZ0JBQUwsS0FBMEI3QixFQUFFLENBQUNtRCxHQUE3QyxJQUNBakIsRUFBRSxLQUFLcEMsQ0FBQyxDQUFDc0QsSUFBVCxJQUFpQixLQUFLdkIsZ0JBQUwsS0FBMEI3QixFQUFFLENBQUNxRCxNQURsRCxFQUVELEtBQUt0QixzQkFBTCxHQWhCZ0UsQ0FrQnBFOzs7QUFDQSxNQUFJLEtBQUtGLGdCQUFMLEtBQTBCN0IsRUFBRSxDQUFDbUQsR0FBakMsRUFDSXhELGNBQWMsQ0FBQzhELHFCQUFmLENBQXFDOUMsS0FBckM7QUFDUCxDQXJCRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIFRva2VuaXplciA9IHJlcXVpcmUoJy4uL3Rva2VuaXplcicpLFxuICAgIGZvcmVpZ25Db250ZW50ID0gcmVxdWlyZSgnLi4vY29tbW9uL2ZvcmVpZ25fY29udGVudCcpLFxuICAgIFVOSUNPREUgPSByZXF1aXJlKCcuLi9jb21tb24vdW5pY29kZScpLFxuICAgIEhUTUwgPSByZXF1aXJlKCcuLi9jb21tb24vaHRtbCcpO1xuXG5cbi8vQWxpYXNlc1xudmFyICQgPSBIVE1MLlRBR19OQU1FUyxcbiAgICBOUyA9IEhUTUwuTkFNRVNQQUNFUztcblxuXG4vL1BhcnNlckZlZWRiYWNrU2ltdWxhdG9yXG4vL1NpbXVsYXRlcyBhZGp1c3RtZW50IG9mIHRoZSBUb2tlbml6ZXIgd2hpY2ggcGVyZm9ybWVkIGJ5IHN0YW5kYXJkIHBhcnNlciBkdXJpbmcgdHJlZSBjb25zdHJ1Y3Rpb24uXG52YXIgUGFyc2VyRmVlZGJhY2tTaW11bGF0b3IgPSBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh0b2tlbml6ZXIpIHtcbiAgICB0aGlzLnRva2VuaXplciA9IHRva2VuaXplcjtcblxuICAgIHRoaXMubmFtZXNwYWNlU3RhY2sgPSBbXTtcbiAgICB0aGlzLm5hbWVzcGFjZVN0YWNrVG9wID0gLTE7XG4gICAgdGhpcy5fZW50ZXJOYW1lc3BhY2UoTlMuSFRNTCk7XG59O1xuXG5QYXJzZXJGZWVkYmFja1NpbXVsYXRvci5wcm90b3R5cGUuZ2V0TmV4dFRva2VuID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5pemVyLmdldE5leHRUb2tlbigpO1xuXG4gICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuaXplci5TVEFSVF9UQUdfVE9LRU4pXG4gICAgICAgIHRoaXMuX2hhbmRsZVN0YXJ0VGFnVG9rZW4odG9rZW4pO1xuXG4gICAgZWxzZSBpZiAodG9rZW4udHlwZSA9PT0gVG9rZW5pemVyLkVORF9UQUdfVE9LRU4pXG4gICAgICAgIHRoaXMuX2hhbmRsZUVuZFRhZ1Rva2VuKHRva2VuKTtcblxuICAgIGVsc2UgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuaXplci5OVUxMX0NIQVJBQ1RFUl9UT0tFTiAmJiB0aGlzLmluRm9yZWlnbkNvbnRlbnQpIHtcbiAgICAgICAgdG9rZW4udHlwZSA9IFRva2VuaXplci5DSEFSQUNURVJfVE9LRU47XG4gICAgICAgIHRva2VuLmNoYXJzID0gVU5JQ09ERS5SRVBMQUNFTUVOVF9DSEFSQUNURVI7XG4gICAgfVxuXG4gICAgZWxzZSBpZiAodGhpcy5za2lwTmV4dE5ld0xpbmUpIHtcbiAgICAgICAgaWYgKHRva2VuLnR5cGUgIT09IFRva2VuaXplci5ISUJFUk5BVElPTl9UT0tFTilcbiAgICAgICAgICAgIHRoaXMuc2tpcE5leHROZXdMaW5lID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRva2VuaXplci5XSElURVNQQUNFX0NIQVJBQ1RFUl9UT0tFTiAmJiB0b2tlbi5jaGFyc1swXSA9PT0gJ1xcbicpIHtcbiAgICAgICAgICAgIGlmICh0b2tlbi5jaGFycy5sZW5ndGggPT09IDEpXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TmV4dFRva2VuKCk7XG5cbiAgICAgICAgICAgIHRva2VuLmNoYXJzID0gdG9rZW4uY2hhcnMuc3Vic3RyKDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRva2VuO1xufTtcblxuLy9OYW1lc3BhY2Ugc3RhY2sgbXV0YXRpb25zXG5QYXJzZXJGZWVkYmFja1NpbXVsYXRvci5wcm90b3R5cGUuX2VudGVyTmFtZXNwYWNlID0gZnVuY3Rpb24gKG5hbWVzcGFjZSkge1xuICAgIHRoaXMubmFtZXNwYWNlU3RhY2tUb3ArKztcbiAgICB0aGlzLm5hbWVzcGFjZVN0YWNrLnB1c2gobmFtZXNwYWNlKTtcblxuICAgIHRoaXMuaW5Gb3JlaWduQ29udGVudCA9IG5hbWVzcGFjZSAhPT0gTlMuSFRNTDtcbiAgICB0aGlzLmN1cnJlbnROYW1lc3BhY2UgPSBuYW1lc3BhY2U7XG4gICAgdGhpcy50b2tlbml6ZXIuYWxsb3dDREFUQSA9IHRoaXMuaW5Gb3JlaWduQ29udGVudDtcbn07XG5cblBhcnNlckZlZWRiYWNrU2ltdWxhdG9yLnByb3RvdHlwZS5fbGVhdmVDdXJyZW50TmFtZXNwYWNlID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMubmFtZXNwYWNlU3RhY2tUb3AtLTtcbiAgICB0aGlzLm5hbWVzcGFjZVN0YWNrLnBvcCgpO1xuXG4gICAgdGhpcy5jdXJyZW50TmFtZXNwYWNlID0gdGhpcy5uYW1lc3BhY2VTdGFja1t0aGlzLm5hbWVzcGFjZVN0YWNrVG9wXTtcbiAgICB0aGlzLmluRm9yZWlnbkNvbnRlbnQgPSB0aGlzLmN1cnJlbnROYW1lc3BhY2UgIT09IE5TLkhUTUw7XG4gICAgdGhpcy50b2tlbml6ZXIuYWxsb3dDREFUQSA9IHRoaXMuaW5Gb3JlaWduQ29udGVudDtcbn07XG5cbi8vVG9rZW4gaGFuZGxlcnNcblBhcnNlckZlZWRiYWNrU2ltdWxhdG9yLnByb3RvdHlwZS5fZW5zdXJlVG9rZW5pemVyTW9kZSA9IGZ1bmN0aW9uICh0bikge1xuICAgIGlmICh0biA9PT0gJC5URVhUQVJFQSB8fCB0biA9PT0gJC5USVRMRSlcbiAgICAgICAgdGhpcy50b2tlbml6ZXIuc3RhdGUgPSBUb2tlbml6ZXIuTU9ERS5SQ0RBVEE7XG5cbiAgICBlbHNlIGlmICh0biA9PT0gJC5QTEFJTlRFWFQpXG4gICAgICAgIHRoaXMudG9rZW5pemVyLnN0YXRlID0gVG9rZW5pemVyLk1PREUuUExBSU5URVhUO1xuXG4gICAgZWxzZSBpZiAodG4gPT09ICQuU0NSSVBUKVxuICAgICAgICB0aGlzLnRva2VuaXplci5zdGF0ZSA9IFRva2VuaXplci5NT0RFLlNDUklQVF9EQVRBO1xuXG4gICAgZWxzZSBpZiAodG4gPT09ICQuU1RZTEUgfHwgdG4gPT09ICQuSUZSQU1FIHx8IHRuID09PSAkLlhNUCB8fFxuICAgICAgICAgICAgIHRuID09PSAkLk5PRU1CRUQgfHwgdG4gPT09ICQuTk9GUkFNRVMgfHwgdG4gPT09ICQuTk9TQ1JJUFQpXG4gICAgICAgIHRoaXMudG9rZW5pemVyLnN0YXRlID0gVG9rZW5pemVyLk1PREUuUkFXVEVYVDtcbn07XG5cblBhcnNlckZlZWRiYWNrU2ltdWxhdG9yLnByb3RvdHlwZS5faGFuZGxlU3RhcnRUYWdUb2tlbiA9IGZ1bmN0aW9uICh0b2tlbikge1xuICAgIHZhciB0biA9IHRva2VuLnRhZ05hbWU7XG5cbiAgICBpZiAodG4gPT09ICQuU1ZHKVxuICAgICAgICB0aGlzLl9lbnRlck5hbWVzcGFjZShOUy5TVkcpO1xuXG4gICAgZWxzZSBpZiAodG4gPT09ICQuTUFUSClcbiAgICAgICAgdGhpcy5fZW50ZXJOYW1lc3BhY2UoTlMuTUFUSE1MKTtcblxuICAgIGlmICh0aGlzLmluRm9yZWlnbkNvbnRlbnQpIHtcbiAgICAgICAgaWYgKGZvcmVpZ25Db250ZW50LmNhdXNlc0V4aXQodG9rZW4pKSB7XG4gICAgICAgICAgICB0aGlzLl9sZWF2ZUN1cnJlbnROYW1lc3BhY2UoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBjdXJyZW50TnMgPSB0aGlzLmN1cnJlbnROYW1lc3BhY2U7XG5cbiAgICAgICAgaWYgKGN1cnJlbnROcyA9PT0gTlMuTUFUSE1MKVxuICAgICAgICAgICAgZm9yZWlnbkNvbnRlbnQuYWRqdXN0VG9rZW5NYXRoTUxBdHRycyh0b2tlbik7XG5cbiAgICAgICAgZWxzZSBpZiAoY3VycmVudE5zID09PSBOUy5TVkcpIHtcbiAgICAgICAgICAgIGZvcmVpZ25Db250ZW50LmFkanVzdFRva2VuU1ZHVGFnTmFtZSh0b2tlbik7XG4gICAgICAgICAgICBmb3JlaWduQ29udGVudC5hZGp1c3RUb2tlblNWR0F0dHJzKHRva2VuKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvcmVpZ25Db250ZW50LmFkanVzdFRva2VuWE1MQXR0cnModG9rZW4pO1xuXG4gICAgICAgIHRuID0gdG9rZW4udGFnTmFtZTtcblxuICAgICAgICBpZiAoIXRva2VuLnNlbGZDbG9zaW5nICYmIGZvcmVpZ25Db250ZW50LmlzSW50ZWdyYXRpb25Qb2ludCh0biwgY3VycmVudE5zLCB0b2tlbi5hdHRycykpXG4gICAgICAgICAgICB0aGlzLl9lbnRlck5hbWVzcGFjZShOUy5IVE1MKTtcbiAgICB9XG5cbiAgICBlbHNlIHtcbiAgICAgICAgaWYgKHRuID09PSAkLlBSRSB8fCB0biA9PT0gJC5URVhUQVJFQSB8fCB0biA9PT0gJC5MSVNUSU5HKVxuICAgICAgICAgICAgdGhpcy5za2lwTmV4dE5ld0xpbmUgPSB0cnVlO1xuXG4gICAgICAgIGVsc2UgaWYgKHRuID09PSAkLklNQUdFKVxuICAgICAgICAgICAgdG9rZW4udGFnTmFtZSA9ICQuSU1HO1xuXG4gICAgICAgIHRoaXMuX2Vuc3VyZVRva2VuaXplck1vZGUodG4pO1xuICAgIH1cbn07XG5cblBhcnNlckZlZWRiYWNrU2ltdWxhdG9yLnByb3RvdHlwZS5faGFuZGxlRW5kVGFnVG9rZW4gPSBmdW5jdGlvbiAodG9rZW4pIHtcbiAgICB2YXIgdG4gPSB0b2tlbi50YWdOYW1lO1xuXG4gICAgaWYgKCF0aGlzLmluRm9yZWlnbkNvbnRlbnQpIHtcbiAgICAgICAgdmFyIHByZXZpb3VzTnMgPSB0aGlzLm5hbWVzcGFjZVN0YWNrW3RoaXMubmFtZXNwYWNlU3RhY2tUb3AgLSAxXTtcblxuICAgICAgICBpZiAocHJldmlvdXNOcyA9PT0gTlMuU1ZHICYmIGZvcmVpZ25Db250ZW50LlNWR19UQUdfTkFNRVNfQURKVVNUTUVOVF9NQVBbdG5dKVxuICAgICAgICAgICAgdG4gPSBmb3JlaWduQ29udGVudC5TVkdfVEFHX05BTUVTX0FESlVTVE1FTlRfTUFQW3RuXTtcblxuICAgICAgICAvL05PVEU6IGNoZWNrIGZvciBleGl0IGZyb20gaW50ZWdyYXRpb24gcG9pbnRcbiAgICAgICAgaWYgKGZvcmVpZ25Db250ZW50LmlzSW50ZWdyYXRpb25Qb2ludCh0biwgcHJldmlvdXNOcywgdG9rZW4uYXR0cnMpKVxuICAgICAgICAgICAgdGhpcy5fbGVhdmVDdXJyZW50TmFtZXNwYWNlKCk7XG4gICAgfVxuXG4gICAgZWxzZSBpZiAodG4gPT09ICQuU1ZHICYmIHRoaXMuY3VycmVudE5hbWVzcGFjZSA9PT0gTlMuU1ZHIHx8XG4gICAgICAgICAgICAgdG4gPT09ICQuTUFUSCAmJiB0aGlzLmN1cnJlbnROYW1lc3BhY2UgPT09IE5TLk1BVEhNTClcbiAgICAgICAgdGhpcy5fbGVhdmVDdXJyZW50TmFtZXNwYWNlKCk7XG5cbiAgICAvLyBOT1RFOiBhZGp1c3QgZW5kIHRhZyBuYW1lIGFzIHdlbGwgZm9yIGNvbnNpc3RlbmN5XG4gICAgaWYgKHRoaXMuY3VycmVudE5hbWVzcGFjZSA9PT0gTlMuU1ZHKVxuICAgICAgICBmb3JlaWduQ29udGVudC5hZGp1c3RUb2tlblNWR1RhZ05hbWUodG9rZW4pO1xufTtcbiJdfQ==